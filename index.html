<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Read & Annotate ‚Äî Candle</title>

<!-- MARKED (markdown renderer) -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
  /* --- Theme variables (candle-lit) --- */
  :root{
    --bg: #0f0b08;           /* deep near-black */
    --panel: #17120f;        /* slightly lighter panel */
    --muted: #c9b89a;        /* candlelight/text */
    --accent: #b36b2c;       /* warm amber */
    --accent-2: #8a5a2a;
    --muted-2: #7b6a58;
    --highlight: rgba(179,107,44,0.18);
    --glass: rgba(255,255,255,0.03);
    --success: #6bbf7a;
    --danger: #d36b6b;
    --radius: 10px;
  }

  /* layout */
  html,body{ height:100%; margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: radial-gradient(1200px 600px at 10% 10%, rgba(179,107,44,0.06), transparent), var(--bg); color:var(--muted); }
  header{ display:flex; align-items:center; justify-content:space-between; padding:14px 20px; background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent); border-bottom:1px solid rgba(255,255,255,0.02); }
  header h1{ margin:0; font-size:18px; color:var(--muted); letter-spacing:0.6px;}
  .wrap{ display:flex; gap:18px; padding:20px; height: calc(100vh - 72px); box-sizing:border-box; }
  .sidebar{ width:300px; background:linear-gradient(180deg,var(--panel), rgba(255,255,255,0.01)); border-radius:var(--radius); padding:14px; box-shadow: 0 6px 20px rgba(0,0,0,0.6); overflow:auto; }
  .main{ flex:1; background: linear-gradient(180deg, rgba(255,255,255,0.01), transparent); border-radius:var(--radius); padding:18px; box-shadow: 0 6px 20px rgba(0,0,0,0.6); overflow:auto; }
  .btn{ background:transparent; border:1px solid rgba(255,255,255,0.03); color:var(--muted); padding:6px 10px; border-radius:8px; cursor:pointer; font-size:13px; }
  .btn-primary{ background: linear-gradient(90deg,var(--accent),var(--accent-2)); border: none; color:#fff; box-shadow: 0 6px 18px rgba(179,107,44,0.12); }

  /* reading list */
  .reading-item{ padding:10px; margin-bottom:8px; border-radius:8px; cursor:pointer; background:var(--glass); transition: all .12s ease; display:flex; justify-content:space-between; align-items:center; }
  .reading-item:hover{ transform: translateY(-3px); box-shadow: 0 8px 18px rgba(0,0,0,0.5); }
  .reading-title{ color:var(--muted); font-weight:600; font-size:14px; }
  .reading-meta{ color:var(--muted-2); font-size:12px; margin-left:8px; }

  /* annotated text and highlights */
  #article { line-height:1.6; color:var(--muted); }
  .hl { background: var(--highlight); border-radius:4px; cursor:pointer; padding:0 2px; }
  .note-bubble{ font-size:12px; color:var(--muted-2); margin-top:6px; padding:8px; background: rgba(255,255,255,0.01); border-radius:8px; border:1px dashed rgba(255,255,255,0.02); }

  /* annotation toolbar */
  .annot-toolbar{ position:fixed; left:50%; transform:translateX(-50%); bottom:28px; display:flex; gap:8px; align-items:center; background:rgba(255,255,255,0.02); padding:8px 12px; border-radius:999px; border:1px solid rgba(255,255,255,0.03); backdrop-filter: blur(4px); }
  .small { font-size:12px; color:var(--muted-2); }

  /* password overlay */
  #pw-overlay{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background: linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.8)); z-index:9999; }
  #pw-box{ background: linear-gradient(180deg, rgba(25,20,18,0.86), rgba(20,16,14,0.9)); padding:24px; border-radius:12px; width:420px; box-shadow: 0 12px 50px rgba(0,0,0,0.8); border:1px solid rgba(255,255,255,0.03); text-align:center; }
  #pw-box input{ width:100%; padding:10px 12px; border-radius:8px; background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted); margin-top:10px; }
  #pw-note{ color:var(--muted-2); font-size:13px; margin-top:8px; }

  /* annotation side list */
  .ann-list{ margin-top:12px; max-height:45vh; overflow:auto; }
  .ann-item{ padding:10px; border-radius:8px; background: rgba(255,255,255,0.01); margin-bottom:8px; border:1px solid rgba(255,255,255,0.02);}
  .ann-item .meta{ font-size:12px; color:var(--muted-2); display:flex; justify-content:space-between; gap:8px; }
  .small-muted{ font-size:12px; color:var(--muted-2); }
  textarea { width:100%; background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,0.03); border-radius:8px; padding:8px; min-height:64px; }

  /* responsive */
  @media (max-width:900px){
    .wrap{ flex-direction:column; padding:12px; }
    .sidebar{ width:100%; order:2; }
    .main{ order:1; }
  }
</style>
</head>
<body>

<header>
  <h1>Read & Annotate ‚Äî Candle</h1>
  <div style="display:flex; gap:10px; align-items:center;">
    <button class="btn" id="theme-toggle" title="Toggle theme">üïØÔ∏è Theme</button>
    <button class="btn" id="export-annotations" title="Export annotations">Export</button>
    <button class="btn" id="clear-local" title="Clear local annotations">Clear local</button>
  </div>
</header>

<div class="wrap">
  <aside class="sidebar">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:8px;">
      <div>
        <div class="small-muted">Readings</div>
        <strong style="font-size:15px">Your readings</strong>
      </div>
      <div style="text-align:right">
        <div class="small-muted">Mode</div>
        <div style="font-size:13px" id="discover-mode">local</div>
      </div>
    </div>

    <div id="reading-list">
      <div class="small-muted">Loading readings‚Ä¶</div>
    </div>

    <hr style="border:none; height:1px; background: rgba(255,255,255,0.02); margin:14px 0;" />

    <div>
      <div class="small-muted">Annotations</div>
      <div class="ann-list" id="annotations-list">
        <div class="small-muted">Select text to create an annotation.</div>
      </div>
    </div>

  </aside>

  <main class="main">
    <div style="display:flex; gap:12px; align-items:center; margin-bottom:12px;">
      <div style="flex:1">
        <div class="small-muted">Viewing</div>
        <h2 id="post-title" style="margin:4px 0 0 0">Nothing loaded</h2>
      </div>
      <div style="min-width:220px; text-align:right;">
        <div class="small-muted">File</div>
        <div id="current-file" class="small-muted">‚Äî</div>
      </div>
    </div>

    <div id="article" tabindex="0" aria-label="Article content" style="padding:6px 2px; border-radius:8px; background: linear-gradient(180deg, rgba(0,0,0,0.02), transparent); max-width:100%;"></div>

    <!-- Annotation editor -->
    <div id="annotation-editor" style="margin-top:16px; display:none;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div><strong>Add annotation</strong></div>
        <div class="small-muted" id="selection-preview"></div>
      </div>
      <textarea id="annotation-text" placeholder="Write your annotation (Markdown is fine)"></textarea>
      <div style="display:flex; gap:8px; margin-top:8px;">
        <button class="btn btn-primary" id="save-annotation">Save</button>
        <button class="btn" id="cancel-annotation">Cancel</button>
      </div>
    </div>
  </main>
</div>

<!-- Annotation toolbar (floating) -->
<div class="annot-toolbar" id="annot-toolbar" style="display:none;">
  <div id="annot-info" class="small-muted">Selected</div>
  <button class="btn btn-primary" id="annot-create">Annotate selected</button>
  <button class="btn" id="annot-cancel">Cancel</button>
</div>

<!-- Password overlay -->
<div id="pw-overlay" style="display:none;">
  <div id="pw-box">
    <h3 style="margin:0 0 6px 0;">Enter site password</h3>
    <div class="small-muted">This site uses a simple local password stored in the page. It's convenient but not secure for sensitive content.</div>
    <input id="pw-input" placeholder="Password" autocomplete="off" />
    <div style="margin-top:8px;">
      <button class="btn btn-primary" id="pw-submit">Unlock</button>
      <button class="btn" id="pw-try-guest">Guest</button>
    </div>
    <div id="pw-note" class="small-muted">If you want a secure gate later, use Cloudflare Access or a proper auth provider.</div>
  </div>
</div>

<script>
/* ================== CONFIG ==================
   Edit these variables to fit your repo setup.
   - PASSWORD: the simple site password (client-side visible).
   - AUTODISCOVER: "indexJson" (recommended) or "githubApi" (fallback).
   - If using githubApi, set REPO_OWNER, REPO_NAME, BRANCH.
   ============================================ */
const PASSWORD = "buttered-candle";       // <-- change me (visible in source)
const AUTODISCOVER = "indexJson";         // "indexJson" | "githubApi"
const REPO_OWNER = "YOUR_GITHUB_USER_OR_ORG"; // required only for githubApi fallback
const REPO_NAME = "YOUR_REPO_NAME";
const REPO_BRANCH = "main";
const READINGS_PATH = "readings"; // folder in the repo or on GitHub Pages

/* How autodiscover works:
  1) Try to fetch: /readings/index.json (best: place a small index.json in the repo, generated by a script).
  2) If that 404s and AUTODISCOVER === 'githubApi', it will call GitHub public API to list files under the readings folder.
     (Works for public repos without auth; rate-limited.)
*/

/* ========= small utilities ========= */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
function el(tag,attrs={},...kids){ const e=document.createElement(tag); Object.assign(e,attrs); for(const k of kids) if(typeof k==='string') e.insertAdjacentHTML('beforeend', k); else e.appendChild(k); return e; }
function escapeHtml(s){ return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"','&quot;'); }

/* ========= storage keys ========= */
const STORAGE_PREFIX = "candle_annot_";
function annKeyFor(filePath){ return STORAGE_PREFIX + "anns::" + filePath; }

/* ========= app state ========= */
let readings = []; // {name, path, title}
let current = { filePath: null, title: null, raw: null, rendered: null };
let pendingSelection = null; // {start,end,text}

/* ========= Password gating (client-side) ========= */
function showPwOverlay(){ $('#pw-overlay').style.display = 'flex'; $('#pw-input').value = ''; $('#pw-input').focus(); }
function hidePwOverlay(){ $('#pw-overlay').style.display = 'none'; }
function isUnlocked(){
  try{ return sessionStorage.getItem('candle_unlocked') === '1'; } catch(e){ return false; }
}
function setUnlocked(){
  try{ sessionStorage.setItem('candle_unlocked','1'); } catch(e){}
}

/* Attach password events */
$('#pw-submit').addEventListener('click', ()=>{
  const v = $('#pw-input').value || '';
  if(v === PASSWORD){ setUnlocked(); hidePwOverlay(); initApp(); }
  else { alert('Wrong password.'); $('#pw-input').focus(); }
});
$('#pw-try-guest').addEventListener('click', ()=>{
  // guest unlock: still marks unlocked but maybe more limited in a secure case
  setUnlocked(); hidePwOverlay(); initApp();
});

/* If not unlocked, show overlay */
if(!isUnlocked()) showPwOverlay(); else initApp();

/* ========== Theme toggle (we keep just the candle theme but allow a lighter mode) ========== */
let lightMode = false;
function applyTheme(){
  if(lightMode){
    document.documentElement.style.setProperty('--bg','#f6f5f3');
    document.documentElement.style.setProperty('--panel','#ffffff');
    document.documentElement.style.setProperty('--muted','#2b2a29');
    document.documentElement.style.setProperty('--accent','#b36b2c');
    document.documentElement.style.setProperty('--highlight','rgba(179,107,44,0.12)');
  } else {
    document.documentElement.style.setProperty('--bg','#0f0b08');
    document.documentElement.style.setProperty('--panel','#17120f');
    document.documentElement.style.setProperty('--muted','#c9b89a');
    document.documentElement.style.setProperty('--accent','#b36b2c');
    document.documentElement.style.setProperty('--highlight','rgba(179,107,44,0.18)');
  }
}
$('#theme-toggle').addEventListener('click', ()=>{ lightMode = !lightMode; applyTheme(); });
applyTheme();

/* ========== Discover readings ========== */
async function discoverReadings(){
  // Try local index.json first (recommended)
  const indexUrl = `/${READINGS_PATH}/index.json`;
  try{
    const res = await fetch(indexUrl, {cache:'no-store'});
    if(res.ok){
      const arr = await res.json();
      // normalize: array of {path, title (optional)}
      readings = arr.map(i => {
        if(typeof i === 'string') return { path: i, title: i.split('/').pop() };
        return { path: i.path, title: i.title || i.path.split('/').pop() };
      });
      $('#discover-mode').innerText = 'index.json';
      renderReadingList();
      return;
    }
  }catch(e){}
  // Fallback: GitHub API (only if allowed)
  if(AUTODISCOVER === 'githubApi'){
    $('#discover-mode').innerText = 'githubApi';
    try{
      const apiUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${READINGS_PATH}?ref=${REPO_BRANCH}`;
      const r = await fetch(apiUrl);
      if(r.ok){
        const json = await r.json();
        // json: array of items with {name, path, download_url}
        readings = json.filter(it => it.type === 'file' && /\.(md|txt|html)$/i.test(it.name)).map(it => {
          return { path: it.path, title: it.name, download_url: it.download_url };
        });
        renderReadingList();
        return;
      } else {
        console.warn('GitHub API error', r.status);
      }
    }catch(e){ console.error(e); }
  }
  // Fallback default (empty)
  $('#reading-list').innerHTML = '<div class="small-muted">No readings found. Place an <code>index.json</code> under <code>/readings/</code> or set AUTODISCOVER to "githubApi".</div>';
}

/* Render reading list */
function renderReadingList(){
  const cont = $('#reading-list');
  if(!readings || readings.length===0){
    cont.innerHTML = '<div class="small-muted">No readings available.</div>'; return;
  }
  cont.innerHTML = '';
  for(const r of readings){
    const item = el('div',{className:'reading-item', onclick: ()=> loadReading(r)}, `<div><div class="reading-title">${escapeHtml(r.title)}</div><div class="reading-meta">${escapeHtml(r.path.split('/').pop())}</div></div><div style="font-size:12px;color:var(--muted-2)">Open</div>`);
    cont.appendChild(item);
  }
}

/* ========== Load a reading file ========= */
async function loadReading(r){
  // r can have download_url (from github API) or path (local path)
  let url = r.download_url || `/${r.path}`;
  const filePath = r.path || r; // path relative to site root
  $('#post-title').innerText = r.title || filePath.split('/').pop();
  $('#current-file').innerText = filePath;
  current.filePath = filePath;
  try{
    const res = await fetch(url, {cache:'no-store'});
    if(!res.ok) throw new Error('Fetch error ' + res.status);
    const raw = await res.text();
    current.raw = raw;
    current.title = r.title || filePath.split('/').pop();
    renderArticleWithAnnotations();
  }catch(e){
    console.error(e);
    $('#article').innerHTML = `<div class="small-muted">Could not load file: ${escapeHtml(url)}</div>`;
  }
}

/* ========== Annotation model (localStorage) ========= */
/* We store for each file a small array of annotations:
   [{id, start, end, note, author, created_at}]
   start/end are character indices relative to current.raw (plain text).
*/
function loadAnns(filePath){
  try{
    const raw = localStorage.getItem(annKeyFor(filePath));
    if(!raw) return [];
    return JSON.parse(raw);
  }catch(e){ console.warn('loadAnns fail',e); return []; }
}
function saveAnns(filePath, arr){
  localStorage.setItem(annKeyFor(filePath), JSON.stringify(arr));
}

/* Build annotated HTML (non-overlapping only) */
function buildAnnotatedHtml(text, anns){
  const a = (anns||[]).slice().sort((x,y)=> x.start - y.start);
  let out = '', cursor = 0;
  for(const ann of a){
    if(ann.start > cursor) out += escapeHtml(text.slice(cursor, ann.start));
    const excerpt = escapeHtml(text.slice(ann.start, ann.end));
    out += `<span class="hl" data-ann-id="${ann.id}" title="${escapeHtml(ann.note || '')}">${excerpt}</span>`;
    cursor = ann.end;
  }
  if(cursor < text.length) out += escapeHtml(text.slice(cursor));
  // convert simple newlines to paragraphs for readability
  out = out.replace(/\n{2,}/g, '</p><p>').replace(/\n/g, '<br>');
  out = `<p>${out}</p>`;
  return out;
}

/* Render article and annotation list */
function renderArticleWithAnnotations(){
  const raw = current.raw || '';
  const anns = loadAnns(current.filePath);
  $('#article').innerHTML = buildAnnotatedHtml(raw, anns);
  renderAnnList(anns);
}

/* Render annotation list UI */
function renderAnnList(anns){
  const cont = $('#annotations-list');
  if(!anns || anns.length===0){ cont.innerHTML = '<div class="small-muted">No annotations yet. Select some text to create one.</div>'; return; }
  cont.innerHTML = '';
  for(const ann of anns.slice().reverse()){
    const excerpt = current.raw.slice(ann.start, ann.end);
    const node = el('div',{className:'ann-item'}, `<div class="meta"><div><strong>${escapeHtml(ann.author||'You')}</strong></div><div class="small-muted">${new Date(ann.created_at).toLocaleString()}</div></div><div style="margin-top:6px">${marked.parseInline(ann.note || '')}</div><div class="note-bubble"><em>Excerpt:</em> "${escapeHtml(excerpt.slice(0,140))}${excerpt.length>140? '‚Ä¶':''}"</div><div style="margin-top:6px; display:flex; gap:8px;"><button class="btn" data-action="jump" data-id="${ann.id}">Jump</button><button class="btn" data-action="edit" data-id="${ann.id}">Edit</button><button class="btn" data-action="delete" data-id="${ann.id}">Delete</button></div>`);
    cont.appendChild(node);
  }
  // attach handlers
  cont.querySelectorAll('[data-action]').forEach(btn=>{
    btn.addEventListener('click', (ev)=>{
      const id = btn.getAttribute('data-id');
      const act = btn.getAttribute('data-action');
      const anns = loadAnns(current.filePath);
      const ann = anns.find(a=>String(a.id)===String(id));
      if(!ann) return alert('Annotation not found.');
      if(act === 'jump'){
        // highlight and scroll into view
        const sp = $('#article').querySelector(`[data-ann-id="${id}"]`);
        if(sp){ sp.scrollIntoView({behavior:'smooth', block:'center'}); sp.animate([{boxShadow:'0 0 0px rgba(0,0,0,0)'}, {boxShadow:'0 6px 36px rgba(179,107,44,0.2)'}], {duration:900, easing:'ease-out'}); }
      } else if(act==='delete'){
        if(!confirm('Delete annotation?')) return;
        const filtered = anns.filter(a=>String(a.id)!==String(id));
        saveAnns(current.filePath, filtered);
        renderArticleWithAnnotations();
      } else if(act==='edit'){
        // open editor prefilled
        pendingSelection = { start: ann.start, end: ann.end, text: current.raw.slice(ann.start, ann.end) };
        $('#selection-preview').innerText = `"${pendingSelection.text.slice(0,80)}${pendingSelection.text.length>80?'‚Ä¶':''}"`;
        $('#annotation-text').value = ann.note || '';
        $('#annotation-editor').style.display = 'block';
        // store a temp id for edit
        $('#annotation-editor').dataset.editing = ann.id;
        window.scrollTo({ top: document.body.scrollHeight, behavior:'smooth' });
      }
    });
  });
}

/* ========== Selection handling ========== */
/* We map selection to character indices inside the current.raw text by creating
   an off-screen text node container that uses textContent (same as earlier approach).
*/
function makeTextHolder(){
  const holder = document.createElement('div');
  holder.id = '__raw_holder';
  holder.style.whiteSpace = 'pre-wrap';
  holder.style.position = 'absolute';
  holder.style.left = '-9999px';
  holder.style.top = '-9999px';
  holder.textContent = current.raw || '';
  document.body.appendChild(holder);
  return holder;
}
function removeTextHolder(){ const h = document.getElementById('__raw_holder'); if(h) h.remove(); }
function getCharOffset(containerEl, node, offset){
  let chars = 0;
  const walker = document.createTreeWalker(containerEl, NodeFilter.SHOW_TEXT);
  let currentNode;
  while(currentNode = walker.nextNode()){
    if(currentNode === node) return chars + offset;
    chars += currentNode.textContent.length;
  }
  return -1;
}

document.addEventListener('selectionchange', ()=>{
  const sel = window.getSelection();
  if(!sel || sel.rangeCount===0) { pendingSelection = null; hideAnnotToolbar(); return; }
  const range = sel.getRangeAt(0);
  if(!current.raw) { pendingSelection = null; hideAnnotToolbar(); return; }

  // Use a hidden holder for consistent offsets
  removeTextHolder();
  const holder = makeTextHolder();
  // locate corresponding DOM nodes in the holder? Simpler: we compute offsets by using the plain holder and mapping selection string to first occurrence
  let text = sel.toString();
  if(!text || text.trim()===''){ pendingSelection = null; hideAnnotToolbar(); removeTextHolder(); return; }
  // We try to find the selected string in the raw text (first match) - robust enough for simple use.
  const raw = current.raw || '';
  const idx = raw.indexOf(text);
  if(idx === -1){
    // fallback: attempt to compute via treewalker relative to article container (not perfect)
    pendingSelection = null; hideAnnotToolbar(); removeTextHolder(); return;
  }
  pendingSelection = { start: idx, end: idx + text.length, text: text };
  showAnnotToolbar(text);
  removeTextHolder();
});

/* toolbar show/hide */
function showAnnotToolbar(text){
  $('#annot-toolbar').style.display = 'flex';
  $('#annot-info').innerText = `"${text.length>40 ? (text.slice(0,40)+'‚Ä¶') : text}"`;
}
function hideAnnotToolbar(){ $('#annot-toolbar').style.display = 'none'; }

/* annotate button -> open editor */
$('#annot-create').addEventListener('click', ()=>{
  if(!pendingSelection) return alert('No selection.');
  $('#selection-preview').innerText = `"${pendingSelection.text.slice(0,90)}${pendingSelection.text.length>90?'‚Ä¶':''}"`;
  $('#annotation-text').value = '';
  $('#annotation-editor').style.display = 'block';
  hideAnnotToolbar();
});

/* cancel annotation editor */
$('#cancel-annotation').addEventListener('click', ()=>{
  $('#annotation-editor').style.display = 'none';
  pendingSelection = null;
  window.getSelection().removeAllRanges();
});

/* save annotation (new or edit) */
$('#save-annotation').addEventListener('click', ()=>{
  const note = $('#annotation-text').value.trim();
  if(!note) return alert('Write a note before saving.');
  const anns = loadAnns(current.filePath) || [];
  const editingId = $('#annotation-editor').dataset.editing;
  if(editingId){
    // edit existing
    const idx = anns.findIndex(a=>String(a.id)===String(editingId));
    if(idx===-1) return alert('Annotation not found for editing.');
    anns[idx].note = note;
    anns[idx].edited_at = new Date().toISOString();
    delete $('#annotation-editor').dataset.editing;
  } else {
    // new annotation
    if(!pendingSelection) return alert('No selection stored.');
    const newAnn = { id: Date.now() + Math.floor(Math.random()*999), start: pendingSelection.start, end: pendingSelection.end, note, author: localStorage.getItem('candle_author') || 'You', created_at: new Date().toISOString() };
    // push
    anns.push(newAnn);
  }
  saveAnns(current.filePath, anns);
  $('#annotation-editor').style.display = 'none';
  pendingSelection = null;
  window.getSelection().removeAllRanges();
  renderArticleWithAnnotations();
});

/* cancel floating toolbar */
$('#annot-cancel').addEventListener('click', ()=>{
  pendingSelection = null; hideAnnotToolbar(); window.getSelection().removeAllRanges();
});

/* article click on a highlight to view note (simple popup) */
document.addEventListener('click', (ev)=>{
  const target = ev.target;
  if(target && target.matches('.hl')){
    const id = target.getAttribute('data-ann-id');
    const anns = loadAnns(current.filePath) || [];
    const ann = anns.find(a=>String(a.id)===String(id));
    if(!ann) return;
    alert(`${ann.author || 'You'} ‚Äî ${new Date(ann.created_at).toLocaleString()}\n\n${ann.note}`);
  }
});

/* export annotations (download JSON) */
$('#export-annotations').addEventListener('click', ()=>{
  if(!current.filePath) return alert('Open a file first.');
  const anns = loadAnns(current.filePath) || [];
  const blob = new Blob([JSON.stringify(anns, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `${current.filePath.replaceAll('/','_')}_annotations.json`;
  a.click();
  URL.revokeObjectURL(url);
});

/* clear local annotations (for current file) */
$('#clear-local').addEventListener('click', ()=>{
  if(!current.filePath) { if(confirm('Clear all local annotations for all files?')) { Array.from(Object.keys(localStorage)).filter(k=>k.startsWith(STORAGE_PREFIX)).forEach(k=>localStorage.removeItem(k)); alert('Cleared.'); renderArticleWithAnnotations(); } return; }
  if(!confirm('Clear local annotations for this file?')) return;
  localStorage.removeItem(annKeyFor(current.filePath));
  renderArticleWithAnnotations();
});

/* ========== Init app ========== */
async function initApp(){
  await discoverReadings();
  // if there is at least one reading, load the first by default
  if(readings && readings.length>0) loadReading(readings[0]);
  else {
    $('#article').innerHTML = `<div class="small-muted">No readings found. Add files in <code>/${READINGS_PATH}/</code> and an <code>index.json</code> or configure AUTODISCOVER.</div>`;
  }
  // restore author name if any
  const a = localStorage.getItem('candle_author');
  if(!a) localStorage.setItem('candle_author','Reader');
}

/* ========== Helpful utilities for repo owners (explain in comments) ========== */

/*
  Recommended: add a small script (run locally or in CI) to generate /readings/index.json.
  Example node script (run from repo root):

  // generate-index.mjs
  import fs from 'fs/promises';
  const path = './readings';
  const files = await fs.readdir(path);
  const arr = files.filter(f=>f.endsWith('.md')||f.endsWith('.txt')||f.endsWith('.html')).map(f=>({ path: path + '/' + f, title: f.replace(/[-_]/g,' ') }));
  await fs.writeFile(path + '/index.json', JSON.stringify(arr, null, 2));
  console.log('wrote readings/index.json');

  Commit index.json and push ‚Äî the page will then discover readings without GitHub API.

  If you prefer not to create index.json, set AUTODISCOVER="githubApi" and configure REPO_OWNER/REPO_NAME.
  For private repos you'd need an authenticated API call (not included here).
*/

/* Kick off if already unlocked (case where user used guest/unlock) */
if(isUnlocked()) {
  // already called initApp at top when unlocking, but re-check
  if(!readings || readings.length===0) discoverReadings();
}
</script>
</body>
</html>
