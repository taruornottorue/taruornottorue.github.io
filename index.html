<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Read & Annotate — Candle (GitHub-backed)</title>

<!-- Markdown renderer -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
/* ========= THEME (candle-like) ========= */
:root{
  --bg: #0f0b08;
  --panel: #17120f;
  --muted: #c9b89a;
  --muted-2: #7b6a58;
  --accent: #b36b2c;
  --glass: rgba(255,255,255,0.02);
  --highlight: rgba(179,107,44,0.18);
  --radius: 10px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--muted);font-family:system-ui, -apple-system, "Segoe UI", Roboto, Arial;}
header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid rgba(255,255,255,0.02);background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);}
h1{margin:0;font-size:16px}
.app{display:flex;height:calc(100vh - 64px);gap:16px;padding:16px;}

/* three columns: left reading list, center article, right annotations */
.col{background:linear-gradient(180deg,var(--panel), rgba(255,255,255,0.01));border-radius:var(--radius);padding:12px;box-shadow:0 8px 30px rgba(0,0,0,0.6);overflow:auto;}
.left{width:280px;flex-shrink:0}
.center{flex:1;min-width:360px}
.right{width:320px;flex-shrink:0}

/* collapsed states */
.collapsed { width: 44px !important; padding:8px !important; overflow:visible !important; }
.collapse-btn { width:36px;height:36px;border-radius:8px;border:1px solid rgba(255,255,255,0.03); background:transparent;color:var(--muted);cursor:pointer; }

/* reading items */
.reading-item{padding:10px;border-radius:8px;background:var(--glass);margin-bottom:8px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;}
.reading-title{font-weight:600}
.small{font-size:12px;color:var(--muted-2)}

/* article + highlights */
#article{line-height:1.6;color:var(--muted);padding:6px;border-radius:8px;background:linear-gradient(180deg, rgba(0,0,0,0.02), transparent);}
.hl{background:var(--highlight);border-radius:4px;padding:0 2px;cursor:pointer;}
.note-bubble{font-size:12px;color:var(--muted-2);margin-top:6px;padding:8px;background:rgba(255,255,255,0.01);border-radius:8px;border:1px dashed rgba(255,255,255,0.02);}

/* annotation editor + list */
.annotation-editor{margin-top:12px}
textarea{width:100%;min-height:88px;border-radius:8px;padding:8px;background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.03);}

/* toolbar floating */
.toolbar{display:flex;gap:8px;align-items:center}

/* PW overlay - fully black opaque */
#pw-overlay{position:fixed;inset:0;z-index:99999;display:flex;align-items:center;justify-content:center;background:#000;color:var(--muted);}
/* inside box */
#pw-box{width:420px;background:#000;padding:22px;border-radius:12px;border:1px solid rgba(255,255,255,0.02);box-shadow:0 12px 60px rgba(0,0,0,0.8);text-align:center}
#pw-box input{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted);margin-top:10px}

/* small responsive */
@media (max-width:980px){
  .app{flex-direction:column;height:calc(100vh - 88px)}
  .left,.right{width:100%;order:2}
  .center{order:1}
}
</style>
</head>
<body>

<header>
  <div style="display:flex;gap:12px;align-items:center">
    <h1>Read & Annotate — Candle</h1>
    <div class="small">private / single annotator mode</div>
  </div>
  <div class="toolbar">
    <button class="collapse-btn" id="collapse-left" title="Toggle readings panel">≡</button>
    <button class="collapse-btn" id="collapse-right" title="Toggle annotations panel">☰</button>
    <button class="collapse-btn" id="cfg-btn" title="Config">⚙︎</button>
  </div>
</header>

<div class="app">
  <!-- left: readings -->
  <aside class="col left" id="left-col">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div><div class="small">Readings</div><strong style="font-size:15px">Your files</strong></div>
      <div class="small" id="discover-mode">local</div>
    </div>
    <div id="reading-list"><div class="small">Loading…</div></div>
    <hr style="border:none;height:1px;background:rgba(255,255,255,0.02);margin:12px 0" />
    <div>
      <div class="small">Index file</div>
      <div class="small" id="index-json-path" style="margin-top:6px;color:var(--muted-2)"></div>
    </div>
  </aside>

  <!-- center: article -->
  <main class="col center">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <div>
        <div class="small">Viewing</div>
        <h2 id="post-title" style="margin:4px 0 0 0">Nothing loaded</h2>
      </div>
      <div style="text-align:right">
        <div class="small">File</div>
        <div id="current-file" class="small">—</div>
      </div>
    </div>
    <div id="article" tabindex="0" aria-label="Article content">
      <div class="small">Open a reading from the left.</div>
    </div>

    <div class="annotation-editor" id="annotation-editor" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Add annotation</strong></div>
        <div class="small" id="selection-preview"></div>
      </div>
      <textarea id="annotation-text" placeholder="Write your note (Markdown allowed)"></textarea>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="collapse-btn" id="save-annotation">Save</button>
        <button class="collapse-btn" id="cancel-annotation">Cancel</button>
        <button class="collapse-btn" id="tog-token">GitHub</button>
      </div>
      <div class="small" style="margin-top:8px;color:var(--muted-2)">Notes saved locally immediately. If GitHub is configured, saves will be pushed to the repo and also available via raw.githubusercontent.com.</div>
    </div>
  </main>

  <!-- right: annotations -->
  <aside class="col right" id="right-col">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div><div class="small">Annotations</div><strong style="font-size:15px">All notes</strong></div>
      <div style="display:flex;gap:6px">
        <button class="collapse-btn" id="export-annotations" title="Export JSON">↓</button>
        <button class="collapse-btn" id="clear-local" title="Clear local">✕</button>
      </div>
    </div>
    <div id="annotations-list"><div class="small">Select text to create an annotation.</div></div>
  </aside>
</div>

<!-- Password overlay (FULL BLACK) -->
<div id="pw-overlay" style="display:none">
  <div id="pw-box">
    <h3 style="margin:0 0 6px 0;color:var(--muted)">Site password</h3>
    <div class="small" style="color:var(--muted-2)">This site uses a local password stored in the page. It's convenient but NOT secure for sensitive data.</div>
    <input id="pw-input" placeholder="Password" autocomplete="off" />
    <div style="margin-top:10px;display:flex;gap:8px;justify-content:center">
      <button class="collapse-btn" id="pw-submit">Unlock</button>
      <button class="collapse-btn" id="pw-guest">Guest</button>
    </div>
  </div>
</div>

<!-- lightweight modal to accept GitHub token -->
<div id="token-modal" style="display:none;position:fixed;left:0;right:0;top:0;bottom:0;z-index:9999;align-items:center;justify-content:center;background:rgba(0,0,0,0.6)">
  <div style="background:var(--panel);padding:16px;border-radius:10px;width:420px;color:var(--muted)">
    <h3 style="margin:0 0 8px 0">GitHub token</h3>
    <div class="small" style="color:var(--muted-2);margin-bottom:8px">Paste a personal access token (repo scope) to allow this page to commit annotation files to your GitHub repo. Token stored in sessionStorage only (per-browser). Only required for push-to-GitHub.</div>
    <input id="gh-token" style="width:100%;padding:8px;border-radius:6px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted)" placeholder="ghp_xxx..." />
    <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end">
      <button class="collapse-btn" id="save-token">Save</button>
      <button class="collapse-btn" id="cancel-token">Cancel</button>
    </div>
  </div>
</div>

<script>
/* ---------------- CONFIG ----------------
 Edit these:
 - PASSWORD: local client-side password (visible in source).
 - AUTODISCOVER: "indexJson" (recommended) or "githubApi"
 - If using githubApi or writing to GitHub, set REPO_OWNER and REPO_NAME/BRANCH.
----------------------------------------- */
const PASSWORD = "buttered-candle"; // change me (visible in source)
const AUTODISCOVER = "indexJson";   // "indexJson" or "githubApi"
const REPO_OWNER = "YOUR_GITHUB_USER_OR_ORG"; // only if githubApi or pushing
const REPO_NAME = "YOUR_REPO_NAME";
const REPO_BRANCH = "main";
const READINGS_PATH = "readings"; // folder path

/* ---------- helpers ---------- */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
function el(tag, attrs={}, html=''){ const e=document.createElement(tag); Object.assign(e, attrs); if(html) e.innerHTML = html; return e; }
function escapeHtml(s){ return (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

/* ---------- state ---------- */
let readings = []; // {path,title,download_url?}
let current = {filePath:null,title:null,raw:null};
let pendingSelection = null;

/* ---------- password gating UI ---------- */
function isUnlocked(){ try { return sessionStorage.getItem('candle_unlocked') === '1'; } catch(e){ return false; } }
function setUnlocked(){ try{ sessionStorage.setItem('candle_unlocked','1'); }catch(e){} }

/* show overlay if needed */
if(!isUnlocked()) $('#pw-overlay').style.display='flex';
else initApp();

/* overlay events */
$('#pw-submit').addEventListener('click', ()=>{
  if($('#pw-input').value === PASSWORD){ setUnlocked(); $('#pw-overlay').style.display='none'; initApp(); }
  else alert('Wrong password');
});
$('#pw-guest').addEventListener('click', ()=>{ setUnlocked(); $('#pw-overlay').style.display='none'; initApp(); });

/* ---------- utility for local storage keys ---------- */
const STORAGE_PREFIX = 'candle_annot_';
function annKeyFor(filePath){ return STORAGE_PREFIX + 'anns::' + filePath; }

/* ---------- discover readings ---------- */
async function discoverReadings(){
  // 1) try /readings/index.json
  const indexPath = `/${READINGS_PATH}/index.json`;
  try{
    const r = await fetch(indexPath, {cache:'no-store'});
    if(r.ok){
      const arr = await r.json();
      readings = arr.map(item => (typeof item === 'string') ? {path:item, title:item.split('/').pop()} : {path:item.path, title:item.title || item.path.split('/').pop(), download_url: item.download_url});
      $('#discover-mode').innerText = 'index.json';
      $('#index-json-path').innerText = indexPath;
      renderReadingList();
      return;
    }
  }catch(e){}
  // 2) fallback: GitHub API (public repo)
  if(AUTODISCOVER === 'githubApi'){
    $('#discover-mode').innerText = 'githubApi';
    try{
      const api = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${READINGS_PATH}?ref=${REPO_BRANCH}`;
      const r = await fetch(api);
      if(r.ok){
        const j = await r.json();
        readings = j.filter(it => it.type === 'file' && /\.(md|txt|html)$/i.test(it.name)).map(it => ({path:it.path, title:it.name, download_url: it.download_url}));
        renderReadingList();
        return;
      }
    }catch(e){}
  }
  // no readings found
  $('#reading-list').innerHTML = '<div class="small">No readings found. Add /readings/index.json or set AUTODISCOVER to githubApi.</div>';
  $('#index-json-path').innerText = '';
}

function renderReadingList(){
  const cont = $('#reading-list');
  cont.innerHTML = '';
  readings.forEach(r=>{
    const item = el('div',{className:'reading-item'});
    item.innerHTML = `<div><div class="reading-title">${escapeHtml(r.title)}</div><div class="small">${escapeHtml(r.path.split('/').pop())}</div></div><div class="small">Open</div>`;
    item.addEventListener('click', ()=> loadReading(r));
    cont.appendChild(item);
  });
}

/* ---------- load reading ---------- */
async function loadReading(r){
  let url = r.download_url || `/${r.path}`;
  $('#post-title').innerText = r.title || r.path.split('/').pop();
  $('#current-file').innerText = r.path;
  current.filePath = r.path;
  try{
    const res = await fetch(url, {cache:'no-store'});
    if(!res.ok) throw new Error('Fetch failed');
    current.raw = await res.text();
    current.title = r.title || r.path.split('/').pop();
    renderArticleWithAnnotations();
  }catch(e){
    $('#article').innerHTML = `<div class="small">Error loading ${escapeHtml(url)}</div>`;
  }
}

/* ---------- annotations model (local + GitHub) ---------- */
function loadAnns(filePath){
  try{
    const raw = localStorage.getItem(annKeyFor(filePath));
    if(!raw) return [];
    return JSON.parse(raw);
  }catch(e){ return []; }
}
function saveAnnsLocal(filePath, arr){
  localStorage.setItem(annKeyFor(filePath), JSON.stringify(arr));
}

/* build annotated HTML (supports duplicate overlapping by simple stacking: non-overlapping assumption best, but duplicates allowed) */
function buildAnnotatedHtml(text, anns){
  // For simplicity: create spans for exact excerpt matches, works well when text not repeated many times.
  // This method replaces tokens sequentially by character indices, which is robust.
  anns = (anns||[]).slice().sort((a,b)=> a.start - b.start);
  let out = '', cursor = 0;
  for(const ann of anns){
    if(ann.start > cursor) out += escapeHtml(text.slice(cursor, ann.start));
    const excerpt = escapeHtml(text.slice(ann.start, ann.end));
    out += `<span class="hl" data-ann-id="${ann.id}" title="${escapeHtml(ann.note||'')}">${excerpt}</span>`;
    cursor = ann.end;
  }
  if(cursor < text.length) out += escapeHtml(text.slice(cursor));
  // turn double newlines to paragraphs for readability
  out = out.replace(/\n{2,}/g, '</p><p>').replace(/\n/g, '<br>');
  return `<p>${out}</p>`;
}

function renderArticleWithAnnotations(){
  const raw = current.raw || '';
  // Try GitHub-hosted annotations first (raw.githubusercontent), then local fallback
  fetchAnnotationsFromGitHub(current.filePath).then(ghAnns=>{
    let anns = ghAnns && ghAnns.length ? ghAnns : loadAnns(current.filePath);
    // save local copy mirror
    saveAnnsLocal(current.filePath, anns);
    $('#article').innerHTML = buildAnnotatedHtml(raw, anns);
    renderAnnList(anns);
  }).catch(_=>{
    const anns = loadAnns(current.filePath);
    $('#article').innerHTML = buildAnnotatedHtml(raw, anns);
    renderAnnList(anns);
  });
}

/* ---------- annotation list UI ---------- */
function renderAnnList(anns){
  const cont = $('#annotations-list');
  if(!anns || anns.length===0){ cont.innerHTML = '<div class="small">No annotations yet.</div>'; return; }
  cont.innerHTML = '';
  anns.slice().reverse().forEach(ann=>{
    const excerpt = current.raw.slice(ann.start, ann.end);
    const node = el('div',{className:'note-bubble'}, `<div style="display:flex;justify-content:space-between"><div><strong>${escapeHtml(ann.author||'You')}</strong></div><div class="small">${new Date(ann.created_at).toLocaleString()}</div></div><div style="margin-top:6px">${marked.parseInline(ann.note||'')}</div><div class="small" style="margin-top:6px"><em>Excerpt:</em> "${escapeHtml(excerpt.slice(0,140))}${excerpt.length>140?'…':''}"</div><div style="margin-top:8px;display:flex;gap:6px"><button class="collapse-btn" data-action="jump" data-id="${ann.id}">Jump</button><button class="collapse-btn" data-action="edit" data-id="${ann.id}">Edit</button><button class="collapse-btn" data-action="delete" data-id="${ann.id}">Delete</button></div>`);
    cont.appendChild(node);
  });
  // attach handlers
  cont.querySelectorAll('[data-action]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.getAttribute('data-id'); const action = btn.getAttribute('data-action');
      const anns = loadAnns(current.filePath) || [];
      const ann = anns.find(a=>String(a.id)===String(id));
      if(!ann) return alert('Not found');
      if(action === 'jump'){
        const el = document.querySelector(`[data-ann-id="${id}"]`);
        if(el){ el.scrollIntoView({behavior:'smooth', block:'center'}); el.animate([{boxShadow:'0 0 0 rgba(0,0,0,0)'},{boxShadow:'0 10px 40px rgba(179,107,44,0.22)'}], {duration:900}); }
      } else if(action === 'delete'){
        if(!confirm('Delete annotation?')) return;
        const filtered = anns.filter(a=>String(a.id)!==String(id));
        saveAnnsLocal(current.filePath, filtered);
        // try push to GitHub (delete on repo)
        attemptPushAnnotations(filtered, current.filePath);
        renderArticleWithAnnotations();
      } else if(action === 'edit'){
        // prepare editor for edit
        pendingSelection = { start: ann.start, end: ann.end, text: current.raw.slice(ann.start, ann.end) };
        $('#selection-preview').innerText = `"${pendingSelection.text.slice(0,90)}${pendingSelection.text.length>90?'…':''}"`;
        $('#annotation-text').value = ann.note || '';
        $('#annotation-editor').style.display = 'block';
        $('#annotation-editor').dataset.editing = ann.id;
      }
    });
  });
}

/* ---------- selection handling ---------- */
/* We map selection to character index by searching the selected string inside current.raw (simple but effective for single annotator) */
document.addEventListener('selectionchange', ()=>{
  const sel = window.getSelection();
  if(!sel || sel.rangeCount === 0){ pendingSelection = null; return; }
  const text = sel.toString();
  if(!text || !current.raw) { pendingSelection = null; return; }
  const idx = current.raw.indexOf(text);
  if(idx === -1){ pendingSelection = null; return; }
  pendingSelection = { start: idx, end: idx + text.length, text };
  // show quick editor area
  $('#selection-preview').innerText = `"${text.length>80? text.slice(0,80)+'…' : text}"`;
  $('#annotation-editor').style.display = 'block';
  $('#annotation-text').value = '';
});

/* ---------- annotation save / edit ---------- */
$('#cancel-annotation').addEventListener('click', ()=>{
  pendingSelection = null; $('#annotation-editor').style.display = 'none'; $('#annotation-editor').dataset.editing = '';
  window.getSelection().removeAllRanges();
});

$('#save-annotation').addEventListener('click', async ()=>{
  if(!current.filePath) return alert('Open a reading first.');
  const note = $('#annotation-text').value.trim();
  if(!note) return alert('Write a note first.');
  let anns = loadAnns(current.filePath) || [];
  const editingId = $('#annotation-editor').dataset.editing;
  if(editingId){
    const idx = anns.findIndex(a => String(a.id) === String(editingId));
    if(idx === -1) return alert('Annotation not found.');
    anns[idx].note = note;
    anns[idx].edited_at = new Date().toISOString();
  } else {
    if(!pendingSelection) return alert('Select text first.');
    const newAnn = {
      id: Date.now() + Math.floor(Math.random()*999),
      start: pendingSelection.start,
      end: pendingSelection.end,
      note,
      author: localStorage.getItem('candle_author') || 'Annotator',
      created_at: new Date().toISOString()
    };
    anns.push(newAnn);
  }
  // Save locally and update UI immediately
  saveAnnsLocal(current.filePath, anns);
  renderArticleWithAnnotations();
  $('#annotation-editor').style.display = 'none';
  $('#annotation-editor').dataset.editing = '';
  pendingSelection = null;
  window.getSelection().removeAllRanges();

  // Now attempt to push the annotations file to GitHub (if token available)
  attemptPushAnnotations(anns, current.filePath);
});

/* ---------- GitHub push helpers ---------- */
/*
  Workflow: annotations are saved to repo path: /annotations/<file-path>-annotations.json
  Example: for readings/sredni.md -> annotations/readings_sredni.md-annotations.json  (we sanitize slashes).
  GitHub API used:
   - GET /repos/:owner/:repo/contents/:path  (to obtain sha if exists)
   - PUT /repos/:owner/:repo/contents/:path  (to create/update)
  The function uses a token (sessionStorage key 'candle_gh_token') — user pastes this once via the modal.
  NOTE: Storing token in localStorage/sessionStorage is NOT cryptographically secure; this is acceptable only for your single-user private setup.
*/

function annotationsFilePathFor(filePath){
  // sanitize to single filename
  const safe = filePath.replaceAll('/','___');
  return `annotations/${safe}-annotations.json`;
}

function getGitHubToken(){ return sessionStorage.getItem('candle_gh_token') || null; }
function setGitHubToken(t){ if(!t) sessionStorage.removeItem('candle_gh_token'); else sessionStorage.setItem('candle_gh_token', t); }

// base64 utf8 helper
function utf8ToBase64(str){
  return btoa(unescape(encodeURIComponent(str)));
}

// get file metadata from GitHub (if exists)
async function githubGetFile(path){
  const token = getGitHubToken();
  if(!token) throw new Error('no-token');
  const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${encodeURIComponent(path)}?ref=${REPO_BRANCH}`;
  const r = await fetch(url, { headers: { Authorization: 'token ' + token, Accept: 'application/vnd.github.v3+json' } });
  if(r.status === 404) return null;
  if(!r.ok) throw new Error('GitHub GET error ' + r.status);
  return await r.json();
}

// create or update file content on GitHub
async function githubPutFile(path, contentText, message){
  const token = getGitHubToken();
  if(!token) throw new Error('no-token');
  const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${encodeURIComponent(path)}`;
  const existing = await githubGetFile(path).catch(e=>{
    if(String(e) === 'Error: no-token') throw e;
    return null;
  });
  const body = {
    message: message || `Update annotations ${path}`,
    content: utf8ToBase64(contentText),
    branch: REPO_BRANCH
  };
  if(existing && existing.sha) body.sha = existing.sha;
  const r = await fetch(url, { method: 'PUT', headers: { Authorization: 'token ' + token, Accept: 'application/vnd.github.v3+json' }, body: JSON.stringify(body) });
  if(!r.ok) {
    const txt = await r.text();
    throw new Error('GitHub PUT failed: ' + r.status + ' ' + txt);
  }
  return await r.json();
}

/* Attempt push, with UI status (non-blocking but executed immediately when user clicks Save) */
async function attemptPushAnnotations(anns, filePath){
  const token = getGitHubToken();
  if(!token){ console.info('No GitHub token; not pushing'); return; }
  const path = annotationsFilePathFor(filePath);
  const payload = JSON.stringify(anns, null, 2);
  // small UI feedback: show small "syncing" indicator in right column top
  const modeEl = el('div', { className: 'small' }, 'Syncing…');
  $('#right-col').insertBefore(modeEl, $('#annotations-list'));
  try{
    await githubPutFile(path, payload, `Update annotations for ${filePath}`);
    // replace indicator
    modeEl.innerText = 'Synced to GitHub';
    setTimeout(()=> modeEl.remove(), 1600);
  }catch(err){
    modeEl.innerText = 'GitHub push failed';
    console.error(err);
    setTimeout(()=> modeEl.remove(), 3000);
  }
}

/* Fetch annotations from GitHub via raw.githubusercontent.com (fast, bypasses Pages build) */
async function fetchAnnotationsFromGitHub(filePath){
  // raw URL pattern: https://raw.githubusercontent.com/:owner/:repo/:branch/:path
  const annotationsPath = annotationsFilePathFor(filePath);
  const rawUrl = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/${REPO_BRANCH}/${annotationsPath}`;
  try{
    const r = await fetch(rawUrl, {cache:'no-store'});
    if(!r.ok) throw new Error('no-raw');
    const json = await r.json();
    return json;
  }catch(e){
    // no remote annotations
    return null;
  }
}

/* ---------- UI: token modal ---------- */
$('#cfg-btn').addEventListener('click', ()=>{ $('#token-modal').style.display = 'flex'; $('#gh-token').value = getGitHubToken() || ''; });
$('#tog-token').addEventListener('click', ()=>{ $('#token-modal').style.display = 'flex'; $('#gh-token').value = getGitHubToken() || ''; });
$('#save-token').addEventListener('click', ()=>{ const v = $('#gh-token').value.trim(); if(!v) return alert('Paste a token or Cancel'); setGitHubToken(v); $('#token-modal').style.display='none'; alert('Token saved to sessionStorage.'); });
$('#cancel-token').addEventListener('click', ()=>{ $('#token-modal').style.display='none'; });

/* ---------- collapse left/right ---------- */
$('#collapse-left').addEventListener('click', ()=>{ $('#left-col').classList.toggle('collapsed'); });
$('#collapse-right').addEventListener('click', ()=>{ $('#right-col').classList.toggle('collapsed'); });

/* ---------- export / clear ---------- */
$('#export-annotations').addEventListener('click', ()=>{
  if(!current.filePath) return alert('Open a file first.');
  const anns = loadAnns(current.filePath) || [];
  const blob = new Blob([JSON.stringify(anns, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `${current.filePath.replaceAll('/','_')}_annotations.json`; a.click(); URL.revokeObjectURL(url);
});
$('#clear-local').addEventListener('click', ()=>{
  if(!confirm('Clear local annotations for current file?')) return;
  if(current.filePath) { localStorage.removeItem(annKeyFor(current.filePath)); renderArticleWithAnnotations(); }
});

/* ---------- init ---------- */
async function initApp(){
  // show index path location
  $('#index-json-path').innerText = `/${READINGS_PATH}/index.json (recommended)`;
  await discoverReadings();
  if(readings.length > 0) loadReading(readings[0]);
  else $('#article').innerHTML = '<div class="small">No readings found in /readings/. Add files or index.json.</div>';
  // default author
  if(!localStorage.getItem('candle_author')) localStorage.setItem('candle_author','Annotator');
}
</script>
</body>
</html>
