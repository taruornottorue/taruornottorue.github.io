<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Read & Annotate — Supabase-backed</title>

<!-- marked (markdown parser) -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<!-- supabase-js -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>

<style>
:root{
  --bg:#0f0b08; --panel:#17120f; --muted:#c9b89a; --muted-2:#7b6a58; --accent:#b36b2c; --glass:rgba(255,255,255,0.02); --highlight:rgba(179,107,44,0.18); --radius:10px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--muted);font-family:system-ui, -apple-system, "Segoe UI", Roboto, Arial;}
header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid rgba(255,255,255,0.02);}
.app{display:flex;height:calc(100vh - 64px);gap:16px;padding:16px;}
.col{background:linear-gradient(180deg,var(--panel), rgba(255,255,255,0.01));border-radius:var(--radius);padding:12px;box-shadow:0 8px 30px rgba(0,0,0,0.6);overflow:auto;}
.left{width:280px;flex-shrink:0}
.center{flex:1;min-width:360px}
.right{width:320px;flex-shrink:0}
.collapsed { width:44px !important; padding:8px !important; overflow:visible !important; }
.collapse-btn { width:36px;height:36px;border-radius:8px;border:1px solid rgba(255,255,255,0.03); background:transparent;color:var(--muted);cursor:pointer; }
.reading-item{padding:10px;border-radius:8px;background:var(--glass);margin-bottom:8px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;}
.small{font-size:12px;color:var(--muted-2)}
#article{line-height:1.6;color:var(--muted);padding:6px;border-radius:8px;background:linear-gradient(180deg, rgba(0,0,0,0.02), transparent);}
.hl{background:var(--highlight);border-radius:4px;padding:0 2px;cursor:pointer;}
.note-bubble{font-size:12px;color:var(--muted-2);margin-top:6px;padding:8px;background:rgba(255,255,255,0.01);border-radius:8px;border:1px dashed rgba(255,255,255,0.02);}
textarea{width:100%;min-height:88px;border-radius:8px;padding:8px;background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.03);}
#pw-overlay{position:fixed;inset:0;z-index:99999;display:flex;align-items:center;justify-content:center;background:#000;color:var(--muted);}
#pw-box{width:420px;background:#000;padding:22px;border-radius:12px;border:1px solid rgba(255,255,255,0.02);text-align:center}
#pw-box input{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted);margin-top:10px}
@media (max-width:980px){ .app{flex-direction:column;height:calc(100vh - 88px)} .left,.right{width:100%;order:2} .center{order:1} }
</style>
</head>
<body>

<header>
  <div style="display:flex;gap:12px;align-items:center"><h1 style="margin:0;font-size:16px">Read & Annotate</h1><div class="small">Supabase-backed — realtime</div></div>
  <div style="display:flex;gap:8px;align-items:center">
    <button class="collapse-btn" id="collapse-left">≡</button>
    <button class="collapse-btn" id="collapse-right">☰</button>
    <button class="collapse-btn" id="clear-local">✕</button>
  </div>
</header>

<div class="app">
  <aside class="col left" id="left-col">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div><div class="small">Readings</div><strong style="font-size:15px">Your files</strong></div>
      <div class="small" id="discover-mode">local</div>
    </div>
    <div id="reading-list"><div class="small">Loading…</div></div>
    <hr style="border:none;height:1px;background:rgba(255,255,255,0.02);margin:12px 0" />
    <div><div class="small">Index file</div><div class="small" id="index-json-path" style="margin-top:6px;color:var(--muted-2)"></div></div>
  </aside>

  <main class="col center">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <div><div class="small">Viewing</div><h2 id="post-title" style="margin:4px 0 0 0">Nothing loaded</h2></div>
      <div style="text-align:right"><div class="small">File</div><div id="current-file" class="small">—</div></div>
    </div>

    <div id="article" tabindex="0">Open a reading from the left.</div>

    <div id="annotation-editor" style="display:none;margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center"><div><strong>Add annotation</strong></div><div class="small" id="selection-preview"></div></div>
      <textarea id="annotation-text" placeholder="Write your note (Markdown allowed)"></textarea>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="collapse-btn" id="save-annotation">Save</button>
        <button class="collapse-btn" id="cancel-annotation">Cancel</button>
      </div>
      <div class="small" style="margin-top:8px;color:var(--muted-2)">Annotations saved to database and pushed via realtime.</div>
    </div>
  </main>

  <aside class="col right" id="right-col">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div><div class="small">Annotations</div><strong style="font-size:15px">All notes</strong></div>
      <div style="display:flex;gap:6px"><div id="sync-status" class="small">—</div></div>
    </div>
    <div id="annotations-list"><div class="small">Select text to create an annotation.</div></div>
  </aside>
</div>

<!-- Password overlay -->
<div id="pw-overlay" style="display:none">
  <div id="pw-box">
    <h3 style="margin:0 0 6px 0;color:var(--muted)">Site password</h3>
    <div class="small" style="color:var(--muted-2)">This is local client-side gating (not server enforced).</div>
    <input id="pw-input" placeholder="Password" autocomplete="off" />
    <div style="margin-top:10px;display:flex;gap:8px;justify-content:center">
      <button class="collapse-btn" id="pw-submit">Unlock</button>
      <button class="collapse-btn" id="pw-guest">Guest</button>
    </div>
  </div>
</div>

<script>
/* ============ CONFIG ============ */
const PASSWORD = "buttered-candle"; // change as you wish
const READINGS_PATH = "readings";
const AUTODISCOVER = "indexJson"; // keep index.json approach
// --- SUPABASE: replace with your project values ---
const SUPABASE_URL = "https://wtpmnawyjzthkrwjpmyv.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind0cG1uYXd5anp0aGtyd2pwbXl2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzNTk4ODQsImV4cCI6MjA4MTkzNTg4NH0.ezh7Ai8oWQL9NiJtdMRQjjbA_MGgb66tdpbFH7ut7Ms";
/* ================================= */

/* setup supabase client */
const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* small helpers */
const $ = s => document.querySelector(s);
function el(tag, attrs={}, html=''){ const e=document.createElement(tag); Object.assign(e, attrs); if(html) e.innerHTML = html; return e; }
function escapeHtml(s){ return (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

/* state */
let readings = [];
let current = { filePath:null, raw:null, title:null };
let pendingSelection = null;

/* password gating */
function isUnlocked(){ try{ return sessionStorage.getItem('candle_unlocked') === '1'; }catch(e){return false;} }
function setUnlocked(){ try{ sessionStorage.setItem('candle_unlocked','1'); }catch(e){} }
if(!isUnlocked()) $('#pw-overlay').style.display = 'flex'; else initApp();
$('#pw-submit').addEventListener('click', ()=>{ if($('#pw-input').value === PASSWORD){ setUnlocked(); $('#pw-overlay').style.display='none'; initApp(); } else alert('Wrong password'); });
$('#pw-guest').addEventListener('click', ()=>{ setUnlocked(); $('#pw-overlay').style.display='none'; initApp(); });

/* discover readings using /readings/index.json */
async function discoverReadings(){
  const indexPath = `/${READINGS_PATH}/index.json`;
  try{
    const r = await fetch(indexPath, {cache:'no-store'});
    if(r.ok){
      const arr = await r.json();
      readings = arr.map(i => typeof i === 'string' ? {path:i, title:i.split('/').pop()} : {path:i.path, title:i.title || i.path.split('/').pop(), download_url:i.download_url});
      $('#discover-mode').innerText = 'index.json';
      $('#index-json-path').innerText = indexPath;
      renderReadingList();
      return;
    }
  }catch(e){}
  $('#reading-list').innerHTML = '<div class="small">No readings found. Add /readings/index.json</div>';
}

/* render reading list */
function renderReadingList(){
  const cont = $('#reading-list'); cont.innerHTML = '';
  readings.forEach(r=>{
    const item = el('div',{className:'reading-item'});
    item.innerHTML = `<div><div class="reading-title">${escapeHtml(r.title)}</div><div class="small">${escapeHtml(r.path.split('/').pop())}</div></div><div class="small">Open</div>`;
    item.addEventListener('click', ()=> loadReading(r));
    cont.appendChild(item);
  });
}

/* load reading content */
async function loadReading(r){
  const url = r.download_url || `/${r.path}`;
  $('#post-title').innerText = r.title || r.path.split('/').pop();
  $('#current-file').innerText = r.path;
  current.filePath = r.path;
  try{
    const res = await fetch(url, {cache:'no-store'});
    if(!res.ok) throw new Error('fetch fail');
    current.raw = await res.text();
    current.title = r.title;
    // render article and load annotations
    await renderArticleWithAnnotations();
    // subscribe to realtime updates for this file
    subscribeToRealtime(current.filePath);
  }catch(e){
    $('#article').innerHTML = `<div class="small">Could not load ${url}</div>`;
  }
}

/* helpers to manipulate annotation DB */
function annKeyFor(filePath){ return 'candle_local::' + filePath; }
function saveLocalAnns(filePath, arr){ localStorage.setItem(annKeyFor(filePath), JSON.stringify(arr)); }
function loadLocalAnns(filePath){ try{ const s = localStorage.getItem(annKeyFor(filePath)); return s ? JSON.parse(s) : []; } catch(e){ return []; } }

/* fetch annotations from Supabase for the loaded file */
async function fetchAnnsFromDb(filePath){
  const { data, error } = await supabase.from('annotations').select('*').eq('file_path', filePath).order('created_at',{ascending:true});
  if(error){ console.warn('fetchAnnsFromDb', error); return null; }
  return data || [];
}

/* render annotated article and annotation list */
async function renderArticleWithAnnotations(){
  const raw = current.raw || '';
  $('#article').innerHTML = '<div class="small">Loading annotations…</div>';
  // get annotations from DB (if available) otherwise local fallback
  const dbAnns = await fetchAnnsFromDb(current.filePath).catch(()=>null);
  const anns = (dbAnns && dbAnns.length) ? dbAnns : loadLocalAnns(current.filePath);
  saveLocalAnns(current.filePath, anns);
  // build html using char indices
  const html = buildAnnotatedHtml(raw, anns);
  $('#article').innerHTML = html;
  renderAnnList(anns);
}

/* build annotated HTML by char indices */
function buildAnnotatedHtml(text, anns){
  anns = (anns || []).slice().sort((a,b)=> a.start_idx - b.start_idx);
  let out = '', cursor = 0;
  for(const ann of anns){
    if(ann.start_idx > cursor) out += escapeHtml(text.slice(cursor, ann.start_idx));
    const excerpt = escapeHtml(text.slice(ann.start_idx, ann.end_idx));
    out += `<span class="hl" data-ann-id="${ann.id}" title="${escapeHtml(ann.note||'')}">${excerpt}</span>`;
    cursor = ann.end_idx;
  }
  if(cursor < text.length) out += escapeHtml(text.slice(cursor));
  out = out.replace(/\n{2,}/g, '</p><p>').replace(/\n/g, '<br>');
  return `<p>${out}</p>`;
}

/* render annotation list UI */
function renderAnnList(anns){
  const cont = $('#annotations-list');
  if(!anns || anns.length===0){ cont.innerHTML = '<div class="small">No annotations yet.</div>'; return; }
  cont.innerHTML = '';
  anns.slice().reverse().forEach(ann=>{
    const excerpt = current.raw.slice(ann.start_idx, ann.end_idx);
    const node = el('div',{className:'note-bubble'}, `<div style="display:flex;justify-content:space-between"><div><strong>${escapeHtml(ann.author||'Annotator')}</strong></div><div class="small">${new Date(ann.created_at).toLocaleString()}</div></div><div style="margin-top:6px">${marked.parseInline(ann.note||'')}</div><div class="small" style="margin-top:6px"><em>Excerpt:</em> "${escapeHtml(excerpt.slice(0,140))}${excerpt.length>140?'…':''}"</div><div style="margin-top:8px;display:flex;gap:6px"><button class="collapse-btn" data-action="jump" data-id="${ann.id}">Jump</button><button class="collapse-btn" data-action="delete" data-id="${ann.id}">Delete</button></div>`);
    cont.appendChild(node);
  });
  cont.querySelectorAll('[data-action]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id = btn.getAttribute('data-id'), action = btn.getAttribute('data-action');
      const anns = await fetchAnnsFromDb(current.filePath) || loadLocalAnns(current.filePath) || [];
      const ann = anns.find(a=>String(a.id)===String(id));
      if(!ann) return alert('Not found');
      if(action === 'jump'){
        const el = document.querySelector(`[data-ann-id="${id}"]`);
        if(el){ el.scrollIntoView({behavior:'smooth', block:'center'}); el.animate([{boxShadow:'0 0 0 rgba(0,0,0,0)'},{boxShadow:'0 10px 40px rgba(179,107,44,0.22)'}], {duration:900}); }
      } else if(action === 'delete'){
        if(!confirm('Delete annotation?')) return;
        // delete from DB
        const { error } = await supabase.from('annotations').delete().eq('id', ann.id);
        if(error) console.warn('delete error', error);
        // re-render
        renderArticleWithAnnotations();
      }
    });
  });
}

/* ---------- selection handling ----------
   We map the selected string to its index in current.raw using indexOf.
   (Good for single-annotator workflows; stable for your use case.)
*/
document.addEventListener('selectionchange', ()=>{
  const sel = window.getSelection();
  if(!sel || sel.rangeCount === 0) { pendingSelection = null; return; }
  const text = sel.toString();
  if(!text || !current.raw) { pendingSelection = null; return; }
  const idx = current.raw.indexOf(text);
  if(idx === -1){ pendingSelection = null; return; }
  pendingSelection = { start_idx: idx, end_idx: idx + text.length, text };
  $('#selection-preview').innerText = `"${text.length>80? text.slice(0,80)+'…' : text}"`;
  $('#annotation-editor').style.display = 'block';
  $('#annotation-text').value = '';
});

/* save annotation -> insert into Supabase; UI updates immediately */
$('#cancel-annotation').addEventListener('click', ()=>{ pendingSelection = null; $('#annotation-editor').style.display = 'none'; window.getSelection().removeAllRanges(); });
$('#save-annotation').addEventListener('click', async ()=>{
  if(!current.filePath) return alert('Open a reading first.');
  const note = $('#annotation-text').value.trim(); if(!note) return alert('Write a note.');
  const author = localStorage.getItem('candle_author') || 'Annotator';
  if(!pendingSelection) return alert('Select text first.');
  // Insert to Supabase
  const payload = { file_path: current.filePath, start_idx: pendingSelection.start_idx, end_idx: pendingSelection.end_idx, note, author };
  // update UI immediately by adding to local copy
  const localAnns = loadLocalAnns(current.filePath);
  const temp = Object.assign({ id: 'temp_' + Date.now(), created_at: new Date().toISOString() }, payload);
  localAnns.push(temp); saveLocalAnns(current.filePath, localAnns); renderArticleWithAnnotations();
  $('#annotation-editor').style.display = 'none'; pendingSelection = null; window.getSelection().removeAllRanges();

  // push to DB
  const { data, error } = await supabase.from('annotations').insert([payload]).select().single();
  if(error){ console.warn('insert error', error); $('#sync-status').innerText = 'Sync failed'; setTimeout(()=>$('#sync-status').innerText = '—', 2500); return; }
  // remove temp local and replace with real saved data
  const anns = loadLocalAnns(current.filePath).filter(a=>!String(a.id).startsWith('temp_'));
  anns.push(data);
  saveLocalAnns(current.filePath, anns);
  renderArticleWithAnnotations();
  $('#sync-status').innerText = 'Synced';
  setTimeout(()=> $('#sync-status').innerText = '—', 1800);
});

/* subscribe to realtime updates so other browsers get them instantly */
let realtimeSubscription = null;
function subscribeToRealtime(filePath){
  if(realtimeSubscription) {
    // remove previous
    try{ supabase.removeChannel(realtimeSubscription); }catch(e){}
    realtimeSubscription = null;
  }
  realtimeSubscription = supabase.channel('public:annotations')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'annotations', filter: `file_path=eq.${filePath}` }, payload => {
      // whenever there's an insert/delete update for this file, refresh UI quickly
      renderArticleWithAnnotations();
    })
    .subscribe((status) => { /* subscription status */ });
}

/* collapse buttons */
$('#collapse-left').addEventListener('click', ()=> $('#left-col').classList.toggle('collapsed'));
$('#collapse-right').addEventListener('click', ()=> $('#right-col').classList.toggle('collapsed'));
$('#clear-local').addEventListener('click', ()=>{
  if(!current.filePath) return alert('Open a file first');
  if(!confirm('Clear local annotations for this file?')) return;
  localStorage.removeItem(annKeyFor(current.filePath));
  renderArticleWithAnnotations();
});

/* init */
async function initApp(){
  await discoverReadings();
  if(readings.length) loadReading(readings[0]);
  else $('#article').innerHTML = '<div class="small">No readings found — add /readings/index.json</div>';
  if(!localStorage.getItem('candle_author')) localStorage.setItem('candle_author','Annotator');
}

/* helper: local ann key */
function annKeyFor(path){ return 'candle_local::' + path; }

</script>
</body>
</html>
