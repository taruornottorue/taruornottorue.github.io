<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Readings & Annotations — Homely Dark UI</title>

<!-- Minimal reset + homely dark theme -->
<style>
  :root{
    --bg: #0f0b07;
    --panel: #1a120d;
    --muted: #bfa892;
    --accent: #ffb86b; /* candle glow */
    --accent-2: #b35e1c;
    --text: #f2eadc;
    --card: #231714;
    --glass: rgba(255,255,255,0.03);
    --radius: 12px;
  }
  *{box-sizing:border-box}
  html,body{height:100%; margin:0;font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:linear-gradient(180deg,var(--bg), #060403); color:var(--text);}
  .app{
    display:grid; grid-template-columns: 1fr 360px; gap:18px; padding:22px; max-width:1200px; margin:20px auto; align-items:start;
  }
  header{display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:8px;}
  h1{margin:0; font-weight:600; letter-spacing:0.2px; color:var(--accent);}
  .subtitle{color:var(--muted); font-size:0.9rem;}
  .panel{background:linear-gradient(180deg,var(--panel), var(--card)); border-radius:var(--radius); padding:18px; box-shadow: 0 6px 18px rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.03);}
  .left{min-height:60vh;}
  .right{min-height:60vh; position:sticky; top:22px;}
  .toolbar{display:flex; gap:8px; align-items:center;margin-bottom:12px;}
  .btn{background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--text); padding:8px 10px; border-radius:10px; cursor:pointer; font-weight:600;}
  .btn.ghost{background:transparent}
  .reading-list{display:flex; flex-direction:column; gap:8px; margin-top:12px;}
  .reading-item{padding:10px; border-radius:10px; cursor:pointer; border:1px dashed rgba(255,255,255,0.03);}
  .reading-item:hover{box-shadow:0 6px 18px rgba(179,94,28,0.06);}
  .title{font-size:1.2rem; margin-bottom:8px; color:var(--accent);}
  #content{padding:18px; background:var(--glass); border-radius:10px; white-space:pre-wrap; line-height:1.6; max-height:70vh; overflow:auto;}
  .highlight{background:linear-gradient(90deg, rgba(255,184,107,0.18), rgba(255,184,107,0.06)); border-bottom:2px solid rgba(179,94,28,0.12); cursor:pointer; padding:0 1px;}
  .floating-toolbar{
    position:fixed; z-index:9999; display:none; gap:8px; padding:8px; border-radius:10px; background:linear-gradient(180deg, rgba(30,18,14,0.95), rgba(15,9,6,0.95)); border:1px solid rgba(255,255,255,0.04);
  }
  .side-annotations{display:flex; flex-direction:column; gap:10px; margin-top:12px; max-height:70vh; overflow:auto;}
  .ann-card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:8px; padding:10px; border:1px solid rgba(255,255,255,0.02);}
  .small{font-size:0.85rem; color:var(--muted)}
  .hidden{display:none}
  .password-modal{
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:99999;
    background:linear-gradient(180deg, rgba(4,2,1,0.6), rgba(3,1,0,0.9));
  }
  .modal-card{width:420px; border-radius:14px; padding:18px; background:linear-gradient(180deg,#2a1610,#1b100b); border:1px solid rgba(255,255,255,0.04); text-align:center;}
  input[type="password"], input[type="text"]{width:100%; padding:10px; margin-top:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:rgba(0,0,0,0.25); color:var(--text);}
  .muted-note{font-size:0.85rem; color:var(--muted); margin-top:10px;}
  .flex{display:flex; gap:8px; align-items:center;}
  .grow{flex:1}
  .tiny{font-size:0.8rem; opacity:0.8}
  .theme-toggle{padding:6px 8px;border-radius:8px}
  .edit-area{width:100%; min-height:60px; padding:8px; border-radius:8px; background:rgba(0,0,0,0.22); color:var(--text); border:1px dashed rgba(255,255,255,0.03);}
  .annotation-meta{display:flex; gap:8px; align-items:center; justify-content:space-between;}
  a.link{color:var(--accent-2); text-decoration:underline}
</style>
</head>
<body>

<header style="max-width:1200px;margin:20px auto;padding:0 22px;display:flex;align-items:center;justify-content:space-between;">
  <div>
    <h1>Reading Room</h1>
    <div class="subtitle">Candle-lit tones, simple password gate, annotations saved to Supabase</div>
  </div>
  <div class="flex">
    <div class="tiny muted-note" id="user-badge">Not signed</div>
    <button class="btn theme-toggle" id="toggle-theme">Toggle theme</button>
  </div>
</header>

<div class="app">

  <div class="left panel">
    <div class="toolbar">
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn" id="refresh">Refresh</button>
        <button class="btn" id="signin-btn">Sign in (magic link)</button>
      </div>
      <div style="margin-left:auto" class="small">Tip: select text to annotate — a floating button will appear.</div>
    </div>

    <div style="display:flex; gap:12px; margin-bottom:12px; align-items:center;">
      <div class="title" id="reading-title">Choose a reading</div>
      <div class="small" id="reading-path"></div>
    </div>

    <div id="content" class="panel" tabindex="0">No reading loaded — choose one from the list on the right.</div>

    <div style="margin-top:12px; display:flex; gap:8px;">
      <input id="annotation-input" class="edit-area hidden" placeholder="Write annotation (press Ctrl+Enter to save)">
      <button id="save-annotation" class="btn hidden">Save</button>
      <button id="cancel-annotation" class="btn hidden">Cancel</button>
    </div>

  </div>

  <aside class="right panel">
    <div>
      <strong>Readings</strong>
      <div class="reading-list panel" id="reading-list" style="margin-top:10px; padding:10px;"></div>
    </div>

    <div style="margin-top:14px;">
      <strong>Annotations</strong>
      <div id="annotations" class="side-annotations"></div>
    </div>

    <div style="margin-top:12px; font-size:0.85rem; color:var(--muted)">
      <div><strong>Add files:</strong> put `your-file.md` in `/readings/` and update `readings/index.json` (or run the helper script below).</div>
      <div style="margin-top:8px;">For shared persistence, this page uses <a class="link" href="https://supabase.com" target="_blank">Supabase</a>. See config in top of script.</div>
    </div>
  </aside>

</div>

<!-- Floating annotate toolbar -->
<div id="floating-toolbar" class="floating-toolbar">
  <button class="btn" id="annotate-btn">Annotate</button>
  <button class="btn" id="quote-btn">Quote</button>
  <button class="btn" id="close-toolbar">X</button>
</div>

<!-- Password modal (shows until password validated) -->
<div id="password-modal" class="password-modal" role="dialog" aria-modal="true">
  <div class="modal-card">
    <h3 style="color:var(--accent)">Welcome — please enter shared password</h3>
    <div class="subtitle">One password shared among your group. (Client-side gating only)</div>
    <input id="password-input" type="password" placeholder="Shared password">
    <div style="display:flex; gap:8px; margin-top:12px;">
      <button id="password-submit" class="btn grow">Enter</button>
      <button id="password-skip" class="btn">Continue anyway</button>
    </div>
    <div class="muted-note">Note: the password is stored only as a hash in this file. This is **not secure** — view source to see why. Use Cloudflare Access for real protection.</div>
  </div>
</div>

<!-- Dependencies -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.js"></script>

<script>
/* ==========================
   CONFIG — edit these values
   ==========================
   - SUPABASE_URL / SUPABASE_ANON_KEY : your Supabase project values
   - PASSWORD_HASH: hex string of SHA-256(password). For convenience produce locally and paste (helper noted below)
   - READING_INDEX: URL path to the JSON index. On GitHub Pages keep it at /readings/index.json
*/
const SUPABASE_URL = "https://YOUR-PROJECT.supabase.co";
const SUPABASE_ANON_KEY = "YOUR_ANON_KEY";

/* SHA-256 hex of your shared password
   -> Locally create it (example Python): 
     python -c "import hashlib; print(hashlib.sha256(b'mysharedsecret').hexdigest())"
   Then paste the hex here.
*/
const PASSWORD_HASH = "PASTE_SHA256_HEX_HERE";

/* Path to the readings index JSON and base dir for markdowns */
const READING_INDEX = "/readings/index.json";
const READING_BASE = "/readings/";

/* supabase client */
const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* -------------------------
   DB Table expected:
   CREATE TABLE annotations (
     id serial PRIMARY KEY,
     file_path text NOT NULL, -- e.g. readings/lecture1.md
     start_idx integer NOT NULL,
     end_idx integer NOT NULL,
     note text NOT NULL,
     author text,
     created_at timestamptz DEFAULT now()
   );
   ------------------------- */

/* ====== UI state ====== */
let readingsIndex = [];     // loaded index from readings/index.json
let currentReading = null;  // {title, path, body}
let annotations = [];       // for current reading
let pendingSelection = null; // {start, end, text}
let currentUser = null;     // from supabase auth (optional)

/* ====== Helpers ====== */
async function sha256hex(str){
  const encoder = new TextEncoder();
  const data = encoder.encode(str);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2,'0')).join('');
}

function escapeHtml(s){ if(!s) return ''; return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }

/* Build annotated HTML from plain raw text and annotation ranges (non-overlapping) */
function buildAnnotatedHtml(text, anns){
  anns = (anns||[]).slice().sort((a,b)=>a.start_idx - b.start_idx);
  let out = "", cursor = 0;
  for(const a of anns){
    if (a.start_idx > cursor) out += escapeHtml(text.slice(cursor,a.start_idx));
    const excerpt = escapeHtml(text.slice(a.start_idx,a.end_idx));
    out += `<span class="highlight" data-id="${a.id}" data-author="${escapeHtml(a.author||'')}">${excerpt}</span>`;
    cursor = a.end_idx;
  }
  if (cursor < text.length) out += escapeHtml(text.slice(cursor));
  return out;
}

/* Character offset utility: compute offset in the container's textContent for an (node, offset) */
function getCharacterOffsetWithin(containerEl, node, offset) {
  let chars = 0;
  const walker = document.createTreeWalker(containerEl, NodeFilter.SHOW_TEXT, null, false);
  let currentNode;
  while ((currentNode = walker.nextNode())) {
    if (currentNode === node) {
      return chars + offset;
    }
    chars += currentNode.textContent.length;
  }
  return -1;
}

/* Position floating toolbar next to the selection */
function placeToolbarForSelection(range){
  const toolbar = document.getElementById('floating-toolbar');
  if (!range) { toolbar.style.display='none'; return; }
  // get bounding rect
  const rect = range.getBoundingClientRect();
  const toolbarRect = toolbar.getBoundingClientRect();
  let top = window.scrollY + rect.top - toolbarRect.height - 8;
  if (top < window.scrollY + 8) top = window.scrollY + rect.bottom + 8;
  let left = window.scrollX + rect.left + (rect.width/2) - (toolbarRect.width/2);
  if (left < 8) left = 8;
  toolbar.style.transform = `translate(${left}px, ${top}px)`;
  toolbar.style.display = 'flex';
}

/* ====== Loading readings index & markdowns ====== */
async function loadReadingsIndex(){
  try{
    const res = await fetch(READING_INDEX);
    if (!res.ok) throw new Error('index.json missing');
    readingsIndex = await res.json();
  }catch(e){
    // fallback: empty
    readingsIndex = [];
    console.warn('Could not load readings index at', READING_INDEX, e);
  }
  renderReadingList();
}

function renderReadingList(){
  const list = document.getElementById('reading-list');
  list.innerHTML = '';
  if (!readingsIndex.length){ list.innerHTML = '<div class="small">No readings found. Add readings/index.json and .md files under /readings/</div>'; return; }
  for(const r of readingsIndex){
    const el = document.createElement('div');
    el.className='reading-item';
    el.innerHTML = `<strong>${escapeHtml(r.title)}</strong><div class="small">${escapeHtml(r.path)}</div>`;
    el.addEventListener('click', ()=>loadReading(r));
    list.appendChild(el);
  }
}

/* Load a reading (markdown file) */
async function loadReading(meta){
  document.getElementById('reading-title').innerText = meta.title || meta.path;
  document.getElementById('reading-path').innerText = meta.path;
  const url = READING_BASE + meta.path;
  try{
    const res = await fetch(url);
    if (!res.ok) throw new Error('not found');
    const md = await res.text();
    currentReading = {title:meta.title, path: meta.path, body: md};
    // Render annotated view: we will render as plain text with highlights for stable offsets
    const content = document.getElementById('content');
    content.innerHTML = ''; // then insert an element that has text nodes (so offsets work)
    const textHolder = document.createElement('div');
    textHolder.id = '__raw_text_holder';
    textHolder.style.whiteSpace='pre-wrap';
    // load annotations for this file
    await loadAnnotationsForFile(meta.path);
    textHolder.innerHTML = buildAnnotatedHtml(md, annotations);
    content.appendChild(textHolder);
    // update annotations list
    renderAnnotationsSidebar();
  }catch(err){
    alert('Could not load reading: '+err.message);
    console.error(err);
  }
}

/* ====== Annotations: load / save / render ====== */
async function loadAnnotationsForFile(path){
  try{
    const { data, error } = await supabase.from('annotations').select('*').eq('file_path', path);
    if (error) { console.error(error); annotations = []; return; }
    annotations = data||[];
  }catch(err){
    console.error(err); annotations=[];
  }
}

function renderAnnotationsSidebar(){
  const container = document.getElementById('annotations');
  container.innerHTML = '';
  if (!annotations.length) { container.innerHTML = '<div class="small">No annotations yet.</div>'; return; }
  // show newest first
  const sorted = annotations.slice().sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));
  for(const a of sorted){
    const card = document.createElement('div');
    card.className='ann-card';
    const excerpt = currentReading.body.slice(a.start_idx, a.end_idx);
    card.innerHTML = `<div class="small"><strong>${escapeHtml(a.author||'Anonymous')}</strong> · ${new Date(a.created_at).toLocaleString()}</div>
      <div style="margin-top:8px;">${escapeHtml(a.note)}</div>
      <div style="margin-top:10px;" class="tiny"><em>Excerpt:</em> "${escapeHtml(excerpt)}"</div>
      <div style="margin-top:8px; text-align:right;">
        <button class="btn" data-id="${a.id}" data-action="jump">Jump</button>
        <button class="btn" data-id="${a.id}" data-action="edit">Edit</button>
        <button class="btn" data-id="${a.id}" data-action="delete">Delete</button>
      </div>`;
    container.appendChild(card);
  }
}

/* Jump to an annotation (scroll & flash) */
function jumpToAnnotationById(id){
  const holder = document.getElementById('__raw_text_holder');
  if (!holder) return;
  const span = holder.querySelector(`span[data-id="${id}"]`);
  if (!span) return;
  span.scrollIntoView({behavior:'smooth', block:'center'});
  // tiny flash
  span.style.transition='box-shadow 0.4s';
  span.style.boxShadow='0 6px 26px rgba(179,94,28,0.25)';
  setTimeout(()=>span.style.boxShadow='',800);
}

/* Save annotation */
async function saveAnnotation(payload){
  const { data, error } = await supabase.from('annotations').insert([payload]).select().single();
  if (error) { alert('Error saving: '+error.message); console.error(error); return null; }
  return data;
}

/* Update annotation */
async function updateAnnotation(id, patch){
  const { data, error } = await supabase.from('annotations').update(patch).eq('id', id).select().single();
  if (error) { alert('Error updating: '+error.message); console.error(error); return null; }
  return data;
}

/* Delete annotation */
async function deleteAnnotation(id){
  const { data, error } = await supabase.from('annotations').delete().eq('id', id).select().single();
  if (error) { alert('Error deleting: '+error.message); console.error(error); return null; }
  return data;
}

/* ====== Selection handling and floating toolbar ====== */
document.addEventListener('selectionchange', ()=>{
  const holder = document.getElementById('__raw_text_holder');
  if (!holder) { pendingSelection = null; document.getElementById('floating-toolbar').style.display='none'; return; }
  const sel = window.getSelection();
  if (sel.rangeCount === 0) { pendingSelection = null; document.getElementById('floating-toolbar').style.display='none'; return; }
  const range = sel.getRangeAt(0);
  if (!holder.contains(range.commonAncestorContainer)) { pendingSelection = null; document.getElementById('floating-toolbar').style.display='none'; return; }
  const start = getCharacterOffsetWithin(holder, range.startContainer, range.startOffset);
  const end = getCharacterOffsetWithin(holder, range.endContainer, range.endOffset);
  if (start === -1 || end === -1 || start === end) { pendingSelection = null; document.getElementById('floating-toolbar').style.display='none'; return; }
  const s = Math.min(start,end), e = Math.max(start,end);
  pendingSelection = {start_idx: s, end_idx: e, text: holder.textContent.slice(s,e), range};
  placeToolbarForSelection(range);
});

/* Floating toolbar actions */
document.getElementById('annotate-btn').addEventListener('click', ()=>{
  if (!pendingSelection) return;
  // show editor below content
  document.getElementById('annotation-input').classList.remove('hidden');
  document.getElementById('save-annotation').classList.remove('hidden');
  document.getElementById('cancel-annotation').classList.remove('hidden');
  document.getElementById('annotation-input').value = '';
  document.getElementById('annotation-input').focus();
});

document.getElementById('quote-btn').addEventListener('click', ()=>{
  if (!pendingSelection) return;
  const boxed = `> ${pendingSelection.text.split('\n').join('\n> ')}\n\n`;
  document.getElementById('annotation-input').classList.remove('hidden');
  document.getElementById('save-annotation').classList.remove('hidden');
  document.getElementById('cancel-annotation').classList.remove('hidden');
  document.getElementById('annotation-input').value = boxed;
  document.getElementById('annotation-input').focus();
});

document.getElementById('close-toolbar').addEventListener('click', ()=>{
  window.getSelection().removeAllRanges();
  pendingSelection = null;
  document.getElementById('floating-toolbar').style.display='none';
});

/* Save/cancel annotation actions */
document.getElementById('cancel-annotation').addEventListener('click', ()=>{
  document.getElementById('annotation-input').classList.add('hidden');
  document.getElementById('save-annotation').classList.add('hidden');
  document.getElementById('cancel-annotation').classList.add('hidden');
  pendingSelection = null;
  window.getSelection().removeAllRanges();
  document.getElementById('floating-toolbar').style.display='none';
});

document.getElementById('save-annotation').addEventListener('click', async ()=>{
  const note = document.getElementById('annotation-input').value.trim();
  if (!pendingSelection || !note) return alert('Select and write a note.');
  const author = currentUser?.email || localStorage.getItem('reader_name') || (prompt('Name to display (Cancel for anonymous)')||null);
  if (author) localStorage.setItem('reader_name', author);
  const payload = {
    file_path: currentReading.path,
    start_idx: pendingSelection.start_idx,
    end_idx: pendingSelection.end_idx,
    note,
    author
  };
  const saved = await saveAnnotation(payload);
  if (saved){
    annotations.push(saved);
    // rerender content highlights
    const holder = document.getElementById('__raw_text_holder');
    holder.innerHTML = buildAnnotatedHtml(currentReading.body, annotations);
    renderAnnotationsSidebar();
    // cleanup
    document.getElementById('annotation-input').classList.add('hidden');
    document.getElementById('save-annotation').classList.add('hidden');
    document.getElementById('cancel-annotation').classList.add('hidden');
    pendingSelection = null;
    window.getSelection().removeAllRanges();
    document.getElementById('floating-toolbar').style.display='none';
  }
});

/* Keyboard shortcut: Ctrl+Enter saves when annotation editor open */
document.addEventListener('keydown', (e)=>{
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
    if (!document.getElementById('annotation-input').classList.contains('hidden')) {
      document.getElementById('save-annotation').click();
    }
  }
});

/* Clicks on annotation side (edit/delete/jump) */
document.getElementById('annotations').addEventListener('click', async (ev)=>{
  const button = ev.target.closest('button');
  if (!button) return;
  const id = button.getAttribute('data-id');
  const action = button.getAttribute('data-action');
  if (action === 'jump') return jumpToAnnotationById(id);
  if (action === 'edit'){
    const ann = annotations.find(a=>String(a.id) === String(id));
    if (!ann) return;
    const newNote = prompt('Edit annotation note:', ann.note);
    if (newNote === null) return;
    const updated = await updateAnnotation(id, {note: newNote});
    if (updated){
      const idx = annotations.findIndex(a=>String(a.id)===String(id));
      annotations[idx] = updated;
      // re-render
      renderAnnotationsSidebar();
    }
  }
  if (action === 'delete'){
    if (!confirm('Delete this annotation?')) return;
    const res = await deleteAnnotation(id);
    if (res){
      annotations = annotations.filter(a=>String(a.id)!==String(id));
      const holder = document.getElementById('__raw_text_holder');
      if (holder) holder.innerHTML = buildAnnotatedHtml(currentReading.body, annotations);
      renderAnnotationsSidebar();
    }
  }
});

/* Clicking a highlighted span should show the note in a small popup — simple approach: alert */
document.getElementById('content').addEventListener('click', (ev)=>{
  const span = ev.target.closest('.highlight');
  if (!span) return;
  const id = span.getAttribute('data-id');
  const ann = annotations.find(a=>String(a.id)===String(id));
  if (!ann) return;
  // show quick view (small custom popup could be implemented; keep simple)
  alert(`${ann.author || 'Anonymous'} — ${new Date(ann.created_at).toLocaleString()}\n\n${ann.note}`);
});

/* ====== Authentication helpers (supabase optional) ====== */
document.getElementById('signin-btn').addEventListener('click', async ()=>{
  const email = prompt('Enter email for magic link:');
  if (!email) return;
  const { error } = await supabase.auth.signInWithOtp({ email });
  if (error) return alert('Error sending link: '+error.message);
  alert('Magic link sent. After signing in refresh the page to see your user badge.');
});

async function refreshState(){
  const s = await supabase.auth.getSession();
  const user = s.data?.session?.user || null;
  currentUser = user;
  document.getElementById('user-badge').innerText = user?.email ? `Signed: ${user.email}` : 'Not signed';
}

/* ====== Password modal logic ====== */
async function checkPasswordAndUnveil(){
  // if previously validated in localStorage, hide modal
  const ok = localStorage.getItem('reading_password_ok');
  if (ok === '1'){ document.getElementById('password-modal').style.display='none'; return; }
  // else show modal (by default it's visible)
  document.getElementById('password-submit').addEventListener('click', async ()=>{
    const v = document.getElementById('password-input').value || '';
    const h = await sha256hex(v);
    if (h === PASSWORD_HASH){
      localStorage.setItem('reading_password_ok','1');
      document.getElementById('password-modal').style.display='none';
      // good to go
      await initAfterUnveil();
    } else {
      alert('Wrong password.');
    }
  });
  document.getElementById('password-skip').addEventListener('click', async ()=>{
    // allow skipping for convenience — still show small warning
    if (!confirm('Continue without entering password? This will not gate the content.')) return;
    document.getElementById('password-modal').style.display='none';
    await initAfterUnveil();
  });
}

/* Called once password gating done (or skipped) */
async function initAfterUnveil(){
  await refreshState();
  await loadReadingsIndex();
}

/* refresh button */
document.getElementById('refresh').addEventListener('click', async ()=>{
  await loadReadingsIndex();
  if (currentReading) await loadAnnotationsForFile(currentReading.path).then(()=> {
    const holder = document.getElementById('__raw_text_holder');
    if (holder) holder.innerHTML = buildAnnotatedHtml(currentReading.body, annotations);
    renderAnnotationsSidebar();
  });
});

/* theme toggle (simple) */
document.getElementById('toggle-theme').addEventListener('click', ()=>{
  // simple invert for demo
  document.body.classList.toggle('light');
  if (document.body.classList.contains('light')){
    document.documentElement.style.setProperty('--bg','#fff');
    document.documentElement.style.setProperty('--panel','#fff');
    document.documentElement.style.setProperty('--text','#111');
    document.documentElement.style.setProperty('--muted','#555');
    document.documentElement.style.setProperty('--accent','#b35e1c');
    document.documentElement.style.setProperty('--glass','rgba(0,0,0,0.02)');
  } else {
    document.documentElement.style.setProperty('--bg','#0f0b07');
    document.documentElement.style.setProperty('--panel','#1a120d');
    document.documentElement.style.setProperty('--text','#f2eadc');
    document.documentElement.style.setProperty('--muted','#bfa892');
    document.documentElement.style.setProperty('--accent','#ffb86b');
    document.documentElement.style.setProperty('--glass','rgba(255,255,255,0.03)');
  }
});

/* ====== Boot ====== */
(async function boot(){
  // small safety: ensure the developer replaced placeholders
  if (SUPABASE_URL.includes('YOUR-PROJECT') || SUPABASE_ANON_KEY.includes('YOUR_ANON_KEY')) {
    console.warn('Supabase config not set — annotations will fail until you set SUPABASE_URL and SUPABASE_ANON_KEY.');
  }
  if (PASSWORD_HASH === "PASTE_SHA256_HEX_HERE") {
    console.warn('PASSWORD_HASH not set — set it to the SHA-256 hex of your shared password.');
  }
  await checkPasswordAndUnveil();
})();
</script>
</body>
</html>
