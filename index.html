<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Read & Annotate — Candle (fixed)</title>

<!-- dependencies -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>

<style>
:root{
  --bg:#0f0b08; --panel:#17120f; --muted:#c9b89a; --muted-2:#7b6a58;
  --accent:#b36b2c; --glass:rgba(255,255,255,0.02); --highlight:rgba(179,107,44,0.18); --radius:10px;
  --collapsed-size:44px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--muted);font-family:system-ui, -apple-system, "Segoe UI", Roboto, Arial;}
header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid rgba(255,255,255,0.02);}
h1{margin:0;font-size:16px}

/* app grid */
.app{display:flex;height:calc(100vh - 64px);gap:12px;padding:12px;}
.col{background:linear-gradient(180deg,var(--panel), rgba(255,255,255,0.01));border-radius:var(--radius);padding:12px;box-shadow:0 8px 30px rgba(0,0,0,0.6);overflow:auto;position:relative;}
.left{width:280px;flex-shrink:0}
.center{flex:1;min-width:360px}
.right{width:320px;flex-shrink:0}

/* collapsed: show only small bar with two-dash icon at top */
.collapsed { width: var(--collapsed-size) !important; padding:8px !important; overflow:visible !important; }
.collapsed .inner-content { display:none !important; }           /* hide all content */
.collapsed .collapsed-handle { display:flex !important; }        /* show handle */
.collapsed .collapsed-handle .dash { display:block; }            /* show dash */
.collapsed .collapsed-handle { position:absolute; top:8px; left:6px; align-items:center; justify-content:center; width:var(--collapsed-size); height:var(--collapsed-size); }

/* collapsed handle (two dash logo) */
.collapsed-handle{display:none; align-items:center; justify-content:center; cursor:pointer; border-radius:8px; background:transparent; color:var(--muted); width:36px; height:36px; border:1px solid rgba(255,255,255,0.03); }
.dash{ font-weight:700; font-size:14px; letter-spacing:6px; color:var(--muted-2); display:none; }

/* reading list */
.reading-item{padding:10px;border-radius:8px;background:var(--glass);margin-bottom:8px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;}
.reading-title{font-weight:600}
.small{font-size:12px;color:var(--muted-2)}

/* article area - we use pre-wrap so newlines are preserved */
#article{line-height:1.6;color:var(--muted);padding:8px;border-radius:8px;white-space:pre-wrap;word-break:break-word; background:linear-gradient(180deg, rgba(0,0,0,0.02), transparent); min-height:200px;}

/* highlights */
.hl{background:var(--highlight);border-radius:4px;padding:0 2px;cursor:pointer;}
.note-bubble{font-size:12px;color:var(--muted-2);margin-top:6px;padding:8px;background:rgba(255,255,255,0.01);border-radius:8px;border:1px dashed rgba(255,255,255,0.02);}

/* floating annotate button */
.floating-annot-btn{position:fixed;z-index:9999;padding:8px 12px;border-radius:999px;background:var(--accent);color:#fff;border:none;box-shadow:0 8px 26px rgba(179,107,44,0.18);cursor:pointer;display:none}

/* annotation editor */
.annotation-editor{margin-top:12px}
textarea{width:100%;min-height:88px;border-radius:8px;padding:8px;background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.03);}

/* password overlay - FULL BLACK opaque */
#pw-overlay{position:fixed;inset:0;z-index:10000;display:flex;align-items:center;justify-content:center;background:#000;color:var(--muted)}
#pw-box{width:420px;background:#000;padding:22px;border-radius:12px;border:1px solid rgba(255,255,255,0.02);text-align:center}
#pw-box input{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted);margin-top:10px}

/* responsive */
@media (max-width:980px){
  .app{flex-direction:column;height:calc(100vh - 88px)}
  .left,.right{width:100%;order:2}
  .center{order:1}
  .collapsed { width:100% !important; }
}
</style>
</head>
<body>

<header>
  <div style="display:flex;gap:12px;align-items:center">
    <h1 style="margin:0">Read & Annotate — Candle</h1>
    <div class="small">single annotator • realtime</div>
  </div>

  <div style="display:flex;gap:8px;align-items:center">
    <button id="collapse-left-btn" style="border-radius:8px;padding:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--muted);cursor:pointer">≡</button>
    <button id="collapse-right-btn" style="border-radius:8px;padding:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--muted);cursor:pointer">☰</button>
    <button id="export-btn" style="border-radius:8px;padding:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--muted);cursor:pointer">Export</button>
  </div>
</header>

<div class="app">
  <!-- LEFT -->
  <aside class="col left" id="left-col">
    <div class="collapsed-handle" style="display:none"><div class="dash">--</div></div>

    <div class="inner-content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div><div class="small">Readings</div><strong style="font-size:15px">Files</strong></div>
        <div class="small" id="discover-mode">local</div>
      </div>
      <div id="reading-list"><div class="small">Loading…</div></div>
      <hr style="border:none;height:1px;background:rgba(255,255,255,0.02);margin:12px 0" />
      <div><div class="small">Index file</div><div id="index-json-path" class="small" style="color:var(--muted-2)"></div></div>
    </div>
  </aside>

  <!-- CENTER -->
  <main class="col center">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <div><div class="small">Viewing</div><h2 id="post-title" style="margin:4px 0 0 0">Nothing loaded</h2></div>
      <div style="text-align:right"><div class="small">File</div><div id="current-file" class="small">—</div></div>
    </div>

    <div id="article" tabindex="0">Open a reading from the left.</div>

    <div id="annotation-editor" class="annotation-editor" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong id="editor-title">Add annotation</strong></div>
        <div class="small" id="selection-preview"></div>
      </div>
      <textarea id="annotation-text" placeholder="Write your note (Markdown allowed)"></textarea>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="save-annotation" style="padding:8px;border-radius:8px;background:var(--accent);color:#fff;border:none;cursor:pointer">Save</button>
        <button id="cancel-annotation" style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted);cursor:pointer">Cancel</button>
      </div>
    </div>
  </main>

  <!-- RIGHT -->
  <aside class="col right" id="right-col">
    <div class="collapsed-handle" style="display:none"><div class="dash">--</div></div>

    <div class="inner-content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div><div class="small">Annotations</div><strong style="font-size:15px">Notes</strong></div>
        <div id="sync-status" class="small">—</div>
      </div>
      <div id="annotations-list"><div class="small">No annotations yet. Select text to create one.</div></div>
    </div>
  </aside>
</div>

<!-- floating annotate button -->
<button id="floating-annot" class="floating-annot-btn">Annotate</button>

<!-- password overlay (full black) -->
<div id="pw-overlay" style="display:none">
  <div id="pw-box">
    <h3 style="margin:0 0 6px 0;color:var(--muted)">Enter site password</h3>
    <div class="small" style="color:var(--muted-2)">This is client-side gating (not server enforced).</div>
    <input id="pw-input" placeholder="Password" autocomplete="off" />
    <div style="margin-top:10px;display:flex;gap:8px;justify-content:center">
      <button id="pw-submit" style="padding:8px;border-radius:8px;background:var(--accent);color:#fff;border:none;cursor:pointer">Unlock</button>
      <button id="pw-guest" style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted);cursor:pointer">Guest</button>
    </div>
  </div>
</div>

<script>
/* =================== CONFIG ===================
 Replace SUPABASE_URL and SUPABASE_ANON_KEY with your Supabase values.
 Add readings/index.json in your repo. Example:
   [ { "path": "readings/sredni.md", "title": "Sredni Vashtar - Saki" } ]
================================================= */
const PASSWORD = "buttered-candle"; // change
const READINGS_PATH = "readings";
const AUTODISCOVER = "indexJson"; // keep indexJson
const SUPABASE_URL = "https://wtpmnawyjzthkrwjpmyv.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind0cG1uYXd5anp0aGtyd2pwbXl2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzNTk4ODQsImV4cCI6MjA4MTkzNTg4NH0.ezh7Ai8oWQL9NiJtdMRQjjbA_MGgb66tdpbFH7ut7Ms";
/* =============================================== */

const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// helpers
const $ = sel => document.querySelector(sel);
function el(tag,attrs={},html=''){ const e=document.createElement(tag); Object.assign(e,attrs); if(html) e.innerHTML = html; return e; }
function escapeHtml(s){ return (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

/* state */
let readings = [];
let current = { filePath:null, raw:null, title:null };
let annotationsCache = []; // loaded annotations for current file
let pendingSelection = null; // {start_idx,end_idx,text}
let isEditingId = null;

// password gating
function isUnlocked(){ try{ return sessionStorage.getItem('candle_unlocked') === '1'; }catch(e){ return false; } }
function setUnlocked(){ try{ sessionStorage.setItem('candle_unlocked','1'); }catch(e){} }

if(!isUnlocked()) $('#pw-overlay').style.display='flex'; else initApp();
$('#pw-submit').addEventListener('click', ()=>{ if($('#pw-input').value === PASSWORD){ setUnlocked(); $('#pw-overlay').style.display='none'; initApp(); } else alert('Wrong password'); });
$('#pw-guest').addEventListener('click', ()=>{ setUnlocked(); $('#pw-overlay').style.display='none'; initApp(); });

/* discover readings (indexJson) */
async function discoverReadings(){
  const idx = `/${READINGS_PATH}/index.json`;
  $('#index-json-path').innerText = idx;
  try {
    const r = await fetch(idx, {cache:'no-store'});
    if(r.ok){
      const arr = await r.json();
      readings = arr.map(i => typeof i === 'string' ? {path:i, title:i.split('/').pop()} : {path:i.path, title:i.title || i.path.split('/').pop(), download_url:i.download_url});
      $('#discover-mode').innerText = 'index.json';
      renderReadingList();
      return;
    }
  } catch(e){}
  $('#reading-list').innerHTML = '<div class="small">No readings found. Add /readings/index.json</div>';
}

/* render readings */
function renderReadingList(){
  const cont = $('#reading-list'); cont.innerHTML = '';
  readings.forEach(r=>{
    const item = el('div',{className:'reading-item'});
    item.innerHTML = `<div><div class="reading-title">${escapeHtml(r.title)}</div><div class="small">${escapeHtml(r.path.split('/').pop())}</div></div><div class="small">Open</div>`;
    item.addEventListener('click', ()=> loadReading(r));
    cont.appendChild(item);
  });
}

/* load a reading file */
async function loadReading(r){
  const url = r.download_url || `/${r.path}`;
  $('#post-title').innerText = r.title || r.path.split('/').pop();
  $('#current-file').innerText = r.path;
  current.filePath = r.path;
  try{
    const res = await fetch(url, {cache:'no-store'});
    if(!res.ok) throw new Error('fetch failed');
    current.raw = await res.text();
    current.title = r.title;
    await loadAnnotationsForCurrent();
    renderArticle();      // render text nodes + highlight spans
    setupRealtimeSubscription();
  }catch(e){
    $('#article').innerHTML = `<div class="small">Could not load ${url}</div>`;
    console.error(e);
  }
}

/* ========== Annotation storage (Supabase) ========== */
async function loadAnnotationsForCurrent(){
  if(!current.filePath) return;
  try{
    const { data, error } = await supabase.from('annotations').select('*').eq('file_path', current.filePath).order('created_at', { ascending: true });
    if(error) { console.warn('fetch anns', error); annotationsCache = loadLocalAnns(); return; }
    annotationsCache = data || [];
    saveLocalAnns(annotationsCache);
  }catch(e){
    console.warn(e);
    annotationsCache = loadLocalAnns();
  }
}

function saveLocalAnns(arr){
  if(!current.filePath) return;
  localStorage.setItem('candle_local::' + current.filePath, JSON.stringify(arr || []));
}
function loadLocalAnns(){
  if(!current.filePath) return [];
  try{ return JSON.parse(localStorage.getItem('candle_local::' + current.filePath) || '[]'); }catch(e){return [];}
}

/* render article using text nodes (keeps character index stability) */
function renderArticle(){
  const container = $('#article');
  container.innerHTML = ''; // clear
  const text = current.raw || '';

  // Build nodes from text and annotation ranges:
  // annotationsCache sorted by start_idx
  const anns = (annotationsCache || []).slice().sort((a,b)=> a.start_idx - b.start_idx);

  let cursor = 0;
  for(const ann of anns){
    if(ann.start_idx > cursor){
      const seg = text.slice(cursor, ann.start_idx);
      container.appendChild(document.createTextNode(seg));
    }
    // create highlight span for annotated portion
    const span = document.createElement('span');
    span.className = 'hl';
    span.dataset.annId = ann.id;
    span.textContent = text.slice(ann.start_idx, ann.end_idx);
    container.appendChild(span);
    cursor = ann.end_idx;
  }
  if(cursor < text.length){
    container.appendChild(document.createTextNode(text.slice(cursor)));
  }

  // set up click handler for highlights
  container.querySelectorAll('.hl').forEach(el=>{
    el.addEventListener('click', (ev)=>{
      const id = el.dataset.annId;
      openAnnotationById(id);
      ev.stopPropagation();
    });
  });
}

/* open annotation in right panel and highlight it */
function openAnnotationById(id){
  const ann = (annotationsCache || []).find(a=>String(a.id) === String(id));
  if(!ann) return;
  // ensure right panel open
  if($('#right-col').classList.contains('collapsed')) toggleRightCollapse();
  // scroll highlight into view
  const el = document.querySelector(`[data-ann-id="${id}"]`);
  if(el){ el.scrollIntoView({behavior:'smooth', block:'center'}); el.animate([{boxShadow:'0 0 0 rgba(0,0,0,0)'},{boxShadow:'0 10px 40px rgba(179,107,44,0.22)'}], {duration:900}); }
  // show annotation in list by focusing it (we re-render list and include jump/edit/delete buttons)
  renderAnnotationList();
  // optionally open an editing UI - here we'll scroll the list and visually mark the item (simple)
  const node = document.querySelector(`#ann-${ann.id}`);
  if(node) node.scrollIntoView({ behavior:'smooth', block:'center' });
}

/* render the annotations list (right column) */
function renderAnnotationList(){
  const cont = $('#annotations-list');
  if(!annotationsCache || annotationsCache.length === 0){ cont.innerHTML = '<div class="small">No annotations yet.</div>'; return; }
  cont.innerHTML = '';
  for(const ann of annotationsCache.slice().reverse()){
    const excerpt = current.raw.slice(ann.start_idx, ann.end_idx);
    const wrapper = el('div', { className: 'note-bubble', id: `ann-${ann.id}` });
    wrapper.innerHTML = `<div style="display:flex;justify-content:space-between"><div><strong>${escapeHtml(ann.author || 'Annotator')}</strong></div><div class="small">${new Date(ann.created_at).toLocaleString()}</div></div><div style="margin-top:6px">${marked.parseInline(ann.note || '')}</div><div class="small" style="margin-top:6px"><em>Excerpt:</em> "${escapeHtml(excerpt.slice(0,140))}${excerpt.length>140?'…':''}"</div><div style="margin-top:8px;display:flex;gap:6px"><button class="collapse-btn" data-action="jump" data-id="${ann.id}">Jump</button><button class="collapse-btn" data-action="edit" data-id="${ann.id}">Edit</button><button class="collapse-btn" data-action="delete" data-id="${ann.id}">Delete</button></div>`;
    cont.appendChild(wrapper);
  }

  // attach handlers
  cont.querySelectorAll('[data-action]').forEach(btn=>{
    btn.addEventListener('click', async (ev)=>{
      const id = btn.getAttribute('data-id'), act = btn.getAttribute('data-action');
      const ann = annotationsCache.find(a => String(a.id) === String(id));
      if(!ann) return alert('Annotation not found');
      if(act === 'jump'){
        openAnnotationById(id);
      } else if(act === 'delete'){
        if(!confirm('Delete annotation?')) return;
        // delete in DB
        const { error } = await supabase.from('annotations').delete().eq('id', ann.id);
        if(error) console.warn(error);
        // reload
        await loadAnnotationsForCurrent();
        renderArticle();
        renderAnnotationList();
      } else if(act === 'edit'){
        // open editor prefilled, set editing id
        isEditingId = ann.id;
        if($('#right-col').classList.contains('collapsed')) toggleRightCollapse();
        $('#annotation-text').value = ann.note || '';
        $('#selection-preview').innerText = `"${current.raw.slice(ann.start_idx, ann.end_idx).slice(0,80)}${ann.end_idx - ann.start_idx > 80 ? '…' : ''}"`;
        $('#annotation-editor').style.display = 'block';
        $('#editor-title').innerText = 'Edit annotation';
      }
    });
  });
}

/* ---------- selection -> show floating annotate button ---------- */
/* We compute start/end indices by using character offsets in the article container
   which we constructed from raw text nodes (so offsets are stable).
*/
function getCharacterOffsetWithin(containerEl, node, offset) {
  // compute char offset of (node, offset) relative to containerEl.textContent
  let chars = 0;
  const walker = document.createTreeWalker(containerEl, NodeFilter.SHOW_TEXT, null, false);
  let currentNode;
  while ((currentNode = walker.nextNode())) {
    if (currentNode === node) {
      return chars + offset;
    }
    chars += currentNode.textContent.length;
  }
  return -1;
}

const floatingBtn = $('#floating-annot');
document.addEventListener('selectionchange', ()=>{
  const sel = window.getSelection();
  if(!sel || sel.rangeCount === 0) { hideFloatingBtn(); pendingSelection = null; return; }
  const range = sel.getRangeAt(0);
  const container = $('#article');
  if(!container.contains(range.commonAncestorContainer)) { hideFloatingBtn(); pendingSelection = null; return; }
  const start = getCharacterOffsetWithin(container, range.startContainer, range.startOffset);
  const end = getCharacterOffsetWithin(container, range.endContainer, range.endOffset);
  if(start === -1 || end === -1 || start === end) { hideFloatingBtn(); pendingSelection = null; return; }
  const s = Math.min(start, end), e = Math.max(start, end);
  pendingSelection = { start_idx: s, end_idx: e, text: container.textContent.slice(s,e) };

  // position floating button near selection
  const rect = range.getBoundingClientRect();
  if(rect && rect.width > 0){
    showFloatingBtn(rect.right - 60, rect.top - 40);
  } else {
    hideFloatingBtn();
  }
});

function showFloatingBtn(x, y){
  floatingBtn.style.left = (x) + 'px';
  floatingBtn.style.top = (y) + 'px';
  floatingBtn.style.display = 'block';
}
function hideFloatingBtn(){
  floatingBtn.style.display = 'none';
}

/* clicking floating annotate -> open right panel editor */
floatingBtn.addEventListener('click', ()=>{
  if(!pendingSelection) return;
  // open right panel if collapsed
  if($('#right-col').classList.contains('collapsed')) toggleRightCollapse();
  $('#annotation-text').value = '';
  $('#selection-preview').innerText = `"${pendingSelection.text.length>90? pendingSelection.text.slice(0,90)+'…': pendingSelection.text}"`;
  $('#annotation-editor').style.display = 'block';
  $('#editor-title').innerText = 'Add annotation';
  hideFloatingBtn();
});

/* save annotated note (new or edit) */
$('#save-annotation').addEventListener('click', async ()=>{
  const note = $('#annotation-text').value.trim();
  if(!note) return alert('Write a note first.');
  const author = localStorage.getItem('candle_author') || 'Annotator';

  if(isEditingId){
    // edit existing
    const payload = { note, edited_at: new Date().toISOString() };
    const { data, error } = await supabase.from('annotations').update(payload).eq('id', isEditingId);
    if(error) console.warn('edit err', error);
    isEditingId = null;
  } else {
    if(!pendingSelection) return alert('Select text first.');
    // optimistic local update: push a temp object
    const temp = { id: 'temp_' + Date.now(), file_path: current.filePath, start_idx: pendingSelection.start_idx, end_idx: pendingSelection.end_idx, note, author, created_at: new Date().toISOString() };
    annotationsCache.push(temp); saveLocalAnns(annotationsCache); renderArticle(); renderAnnotationList();
    $('#annotation-editor').style.display = 'none';
    pendingSelection = null; window.getSelection().removeAllRanges();
    // insert to Supabase
    const { data, error } = await supabase.from('annotations').insert([{ file_path: current.filePath, start_idx: temp.start_idx, end_idx: temp.end_idx, note, author }]).select().single();
    if(error){ console.warn(error); $('#sync-status').innerText = 'Sync failed'; setTimeout(()=>$('#sync-status').innerText = '—',2000); return; }
    // replace temp with real data
    annotationsCache = annotationsCache.filter(a=>!String(a.id).startsWith('temp_'));
    annotationsCache.push(data);
    saveLocalAnns(annotationsCache);
    renderArticle(); renderAnnotationList();
    $('#sync-status').innerText = 'Synced';
    setTimeout(()=>$('#sync-status').innerText = '—',1400);
  }
});

/* cancel edit/new */
$('#cancel-annotation').addEventListener('click', ()=>{
  isEditingId = null;
  $('#annotation-editor').style.display = 'none';
  pendingSelection = null;
  window.getSelection().removeAllRanges();
});

/* realtime subscription: subscribe to changes for current file */
let currentSubscription = null;
function setupRealtimeSubscription(){
  if(currentSubscription) { try{ supabase.removeChannel(currentSubscription); }catch(e){} currentSubscription = null; }
  if(!current.filePath) return;
  currentSubscription = supabase.channel('public:annotations:'+current.filePath)
    .on('postgres_changes', { event: '*', schema: 'public', table: 'annotations', filter: `file_path=eq.${current.filePath}` }, payload => {
      // when other clients add/update/delete, re-fetch
      setTimeout(async ()=> {
        await loadAnnotationsForCurrent();
        renderArticle();
        renderAnnotationList();
      }, 100);
    })
    .subscribe(status => {
      // console.log('sub status', status);
    });
}

/* export annotations to JSON file download */
$('#export-btn').addEventListener('click', ()=>{
  if(!current.filePath) return alert('Open a file first.');
  const blob = new Blob([JSON.stringify(annotationsCache, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `${current.filePath.replaceAll('/','_')}_annotations.json`; a.click(); URL.revokeObjectURL(url);
});

/* collapse left/right behaviours */
function toggleLeftCollapse(){ $('#left-col').classList.toggle('collapsed'); updateCollapsedUI(); }
function toggleRightCollapse(){ $('#right-col').classList.toggle('collapsed'); updateCollapsedUI(); }
$('#collapse-left-btn').addEventListener('click', toggleLeftCollapse);
$('#collapse-right-btn').addEventListener('click', toggleRightCollapse);

function updateCollapsedUI(){
  // show/hide dash handles
  const leftCollapsed = $('#left-col').classList.contains('collapsed');
  const rightCollapsed = $('#right-col').classList.contains('collapsed');
  document.querySelectorAll('.left .collapsed-handle').forEach(n=> leftCollapsed ? n.style.display = 'flex' : n.style.display = 'none');
  document.querySelectorAll('.right .collapsed-handle').forEach(n=> rightCollapsed ? n.style.display = 'flex' : n.style.display = 'none');
  // when collapsed ensure there is no textual content visible (CSS hides .inner-content)
}

/* clicking collapsed-handle toggles back */
document.querySelectorAll('.collapsed-handle').forEach(h=>{
  h.addEventListener('click', (ev)=>{
    const col = h.closest('.col');
    col.classList.toggle('collapsed');
    updateCollapsedUI();
    ev.stopPropagation();
  });
});

/* load initial readings and bootstrap */
async function initApp(){
  await discoverReadings();
  if(readings.length > 0) loadReading(readings[0]);
  else $('#article').innerHTML = '<div class="small">No readings found. Add /readings/index.json</div>';
  if(!localStorage.getItem('candle_author')) localStorage.setItem('candle_author','Annotator');
}

/* helper to open an annotation when highlight clicked */
function openAnnotationFromHighlight(ev){
  const el = ev.target;
  if(!el.classList.contains('hl')) return;
  const annId = el.dataset.annId;
  openAnnotationById(annId);
}

/* attach global clicks to close editor when clicking outside */
document.addEventListener('click', (ev)=>{
  const insideArticle = $('#article').contains(ev.target);
  const insideEditor = $('#annotation-editor').contains(ev.target);
  const insideAnnotBtn = floatingBtn.contains(ev.target);
  if(!insideEditor && !insideAnnotBtn && !insideArticle){
    // close floating button & selection
    hideFloatingBtn();
  }
});

/* keyboard shortcuts */
document.addEventListener('keydown', (ev)=>{
  if(ev.key === 'Escape'){
    hideFloatingBtn();
    $('#annotation-editor').style.display = 'none';
    pendingSelection = null;
    isEditingId = null;
    window.getSelection().removeAllRanges();
  }
});

/* load on start if unlocked */
if(isUnlocked()) initApp();
</script>
</body>
</html>
