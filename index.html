<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Homely Annotator (local) ‚Äî Fixed Password</title>
<style>
  :root{
    --bg:#fff8f2; --panel:#fff; --muted:#6b5b4a; --accent:#f6c07d; --accent-2:#ffb86b; --card-shadow: 0 6px 18px rgba(98,76,54,0.08); --glass: rgba(255,255,255,0.6);
  }
  [data-theme="dark"]{ --bg:#0f1213; --panel:#111314; --muted:#bfbfbf; --accent:#b36b1b; --accent-2:#d88b3a; --card-shadow: 0 6px 18px rgba(0,0,0,0.6); --glass: rgba(255,255,255,0.03); }
  *{box-sizing:border-box}
  html,body{height:100%; margin:0; font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:linear-gradient(180deg,var(--bg),#fff); color:var(--muted);}
  .app{display:flex; height:100vh; gap:12px; padding:18px;}
  .left, .center, .right { background:var(--panel); border-radius:14px; box-shadow:var(--card-shadow); padding:14px; }
  .left{width:260px; flex-shrink:0; display:flex; flex-direction:column; gap:12px;}
  .center{flex:1; display:flex; flex-direction:column; gap:12px; overflow:auto;}
  .right{width:320px; flex-shrink:0; overflow:auto;}
  h1{margin:0; font-size:1.1rem}
  .btn{background:linear-gradient(180deg,var(--accent),var(--accent-2)); border:none; color:#fff; padding:8px 10px; border-radius:10px; cursor:pointer;}
  .btn-ghost{background:transparent; border:1px solid rgba(0,0,0,0.06); padding:8px 10px; border-radius:10px; cursor:pointer;}
  .small{font-size:0.9rem; color:var(--muted)}
  .list-item{padding:8px;border-radius:10px; cursor:pointer; display:flex; gap:8px; align-items:center;}
  .list-item:hover{background:var(--glass);}
  input[type="file"]{display:none;}
  .reading-title{font-weight:600; font-size:1.05rem; margin-bottom:6px;}
  #reading { white-space: pre-wrap; line-height:1.6; padding:14px; border-radius:10px; background:linear-gradient(180deg,transparent, rgba(0,0,0,0.02)); min-height:300px; }
  .highlight { background: #fff49a; border-radius:4px; padding:0 1px; cursor:pointer; }
  .floating-toolbar{position:absolute; z-index:9999; background:var(--panel); border-radius:8px; box-shadow:var(--card-shadow); padding:6px; display:flex; gap:6px; align-items:center; }
  .modal {position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(10,10,10,0.4); z-index:10000;}
  .card {background:var(--panel); padding:18px; border-radius:12px; width:520px; box-shadow:var(--card-shadow);}
  .field{margin-bottom:8px}
  .muted{color:var(--muted); font-size:0.9rem}
  .annotation-item{padding:8px; border-radius:8px; margin-bottom:8px; background:linear-gradient(180deg, rgba(246,192,125,0.06), rgba(0,0,0,0.01))}
  .meta{font-size:0.85rem; color:var(--muted);}
  .topbar{display:flex; justify-content:space-between; align-items:center; gap:12px;}
  .footer-note{font-size:0.82rem; color:var(--muted); margin-top:8px}
  .chip{background:rgba(0,0,0,0.03); padding:6px 8px; border-radius:999px; font-size:0.85rem}
  @keyframes pop { from { transform:scale(.98); opacity:0 } to { transform:none; opacity:1 } }
  .floating-toolbar{animation:pop .12s ease-out;}
  .shake { animation: shake .28s; }
  @keyframes shake { 0%{transform:translateX(0)} 25%{transform:translateX(-6px)} 50%{transform:translateX(6px)} 75%{transform:translateX(-4px)} 100%{transform:translateX(0)} }
  @media (max-width:900px){ .left{display:none} .right{display:none} .app{padding:12px} }
  /* password box styles */
  .pw-input { width:100%; padding:10px 12px; border-radius:10px; border:1px solid #ddd; font-size:1rem; }
  .pw-row{display:flex; gap:8px; align-items:center}
  .pw-error{color:#b33; font-size:0.9rem; margin-top:8px}
  .pw-foot{font-size:0.9rem; color:var(--muted); margin-top:6px}
</style>
</head>
<body>
<!-- PASSWORD MODAL -->
<div id="password-modal" class="modal" aria-hidden="false" role="dialog" aria-modal="true">
  <div class="card" style="max-width:540px;">
    <h1>Enter shared password</h1>
    <div class="muted" style="margin-bottom:12px">This is a simple client-side gate for local use. Change the password in the script <code>PASSWORD</code> constant.</div>
    <div class="field">
      <div class="pw-row">
        <input id="pw-input" class="pw-input" type="password" placeholder="Shared password" autocomplete="off" aria-label="Shared password">
        <button id="pw-toggle" class="btn-ghost" title="Show password">üëÅÔ∏è</button>
        <button id="pw-submit" class="btn">Unlock</button>
      </div>
      <div id="pw-error" class="pw-error" role="status" aria-live="polite" style="display:none;"></div>
      <div class="pw-foot">Tip: password is case-sensitive; leading/trailing spaces are ignored.</div>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app" class="app" style="display:none" data-theme="light">
  <div class="left">
    <div class="topbar">
      <div>
        <h1>Readings</h1>
        <div class="muted">Upload / create / manage</div>
      </div>
      <div style="text-align:right">
        <button id="theme-toggle" class="chip small">üåô</button>
      </div>
    </div>

    <div>
      <input id="file-input" type="file" accept=".txt,.md" />
      <label for="file-input" class="btn-ghost" style="display:inline-block; cursor:pointer;">Upload</label>
      <button id="new-btn" class="btn-ghost">New</button>
    </div>

    <div id="reading-list" style="margin-top:10px; overflow:auto;"></div>

    <hr style="border:none; height:1px; background:rgba(0,0,0,0.04); margin:12px 0;" />
    <div>
      <button id="export-btn" class="btn-ghost">Export data</button>
      <button id="import-btn" class="btn-ghost">Import data</button>
      <input id="import-file" type="file" accept="application/json" style="display:none">
      <div class="footer-note">Data stored in <code>localStorage</code>. Backup with Export.</div>
    </div>
  </div>

  <div class="center">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <div>
        <div class="reading-title" id="title-area">No reading selected</div>
        <div class="muted" id="meta-area"></div>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <div class="muted small">Annotator</div>
        <input id="author-input" placeholder="Your name (saved locally)" style="padding:6px 8px; border-radius:8px; border:1px solid #ddd"/>
      </div>
    </div>

    <div id="reading" tabindex="0" role="article" aria-label="Reading text"></div>
    <div class="muted" style="margin-top:10px">Select text to annotate. Use Export to back up annotations.</div>
  </div>

  <div class="right">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h2 style="margin:0">Annotations</h2>
      <div class="muted small">Click to jump</div>
    </div>
    <div id="annotations-list" style="margin-top:10px"></div>
  </div>
</div>

<!-- toolbar + annotation modal (same as before) -->
<div id="toolbar" class="floating-toolbar" style="display:none;">
  <button id="annotate-btn" class="btn-ghost">‚úçÔ∏è Annotate</button>
  <button id="highlight-btn" class="btn-ghost">üîÜ Highlight</button>
  <button id="clear-selection" class="btn-ghost">‚úñ</button>
</div>

<div id="annot-modal" class="modal" style="display:none;">
  <div class="card" role="dialog" aria-modal="true">
    <h2 style="margin-top:0">Add annotation</h2>
    <div class="muted" id="sel-preview" style="margin-bottom:8px"></div>
    <div class="field">
      <textarea id="note-input" placeholder="Write a short note" style="width:100%; min-height:96px; padding:8px; border-radius:8px; border:1px solid #ddd"></textarea>
    </div>
    <div style="display:flex; gap:8px; justify-content:flex-end;">
      <button id="save-annot" class="btn">Save</button>
      <button id="cancel-annot" class="btn-ghost">Cancel</button>
    </div>
  </div>
</div>

<script>
/* CONFIG */
const PASSWORD = "letmein"; // <-- set shared password here (exact match after trimming)

/* Storage keys */
const STORAGE_READINGS = 'homely_readings_v2';
const STORAGE_ANNOT = 'homely_annotations_v2';

/* STATE */
const state = { currentReadingId: null, readings: {}, annotations: {}, pendingSelection: null, theme: 'light' };

/* UTIL: load/save */
function saveAll(){ localStorage.setItem(STORAGE_READINGS, JSON.stringify(state.readings)); localStorage.setItem(STORAGE_ANNOT, JSON.stringify(state.annotations)); }
function loadAll(){
  try{ state.readings = JSON.parse(localStorage.getItem(STORAGE_READINGS) || '{}'); } catch(e){ state.readings = {}; }
  try{ state.annotations = JSON.parse(localStorage.getItem(STORAGE_ANNOT) || '{}'); } catch(e){ state.annotations = {}; }
}
loadAll();

/* DOM refs */
const pwModal = document.getElementById('password-modal');
const pwInput = document.getElementById('pw-input');
const pwSubmit = document.getElementById('pw-submit');
const pwError = document.getElementById('pw-error');
const pwToggle = document.getElementById('pw-toggle');
const app = document.getElementById('app');

const fileInput = document.getElementById('file-input');
const importFile = document.getElementById('import-file');
const readingList = document.getElementById('reading-list');
const readingEl = document.getElementById('reading');
const titleArea = document.getElementById('title-area');
const metaArea = document.getElementById('meta-area');
const annotationsList = document.getElementById('annotations-list');
const toolbar = document.getElementById('toolbar');
const annotModal = document.getElementById('annot-modal');
const selPreview = document.getElementById('sel-preview');
const noteInput = document.getElementById('note-input');

/* Password UX behavior */
/* Keep simple: trim input, compare to PASSWORD. Provide clear message on failure. */
pwSubmit.addEventListener('click', tryPw);
pwInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') tryPw(); });
pwToggle.addEventListener('click', ()=> {
  const t = pwInput.getAttribute('type') === 'password' ? 'text' : 'password';
  pwInput.setAttribute('type', t);
  pwToggle.textContent = t === 'password' ? 'üëÅÔ∏è' : 'üôà';
});

/* Check sessionStorage for unlocked state */
if(sessionStorage.getItem('homely_unlocked') === '1') {
  pwModal.style.display = 'none';
  app.style.display = 'flex';
  initUI();
} else {
  // Focus input automatically
  pwInput.focus();
}

function tryPw(){
  const val = (pwInput.value || '').trim();
  // Clear any previous error
  pwError.style.display = 'none';
  pwModal.classList.remove('shake');
  if(!val){
    showPwError('Please enter the password.');
    return;
  }
  if(val === PASSWORD){
    sessionStorage.setItem('homely_unlocked', '1');
    pwModal.style.display = 'none';
    app.style.display = 'flex';
    // clear pw input for hygiene
    pwInput.value = '';
    initUI();
    return;
  }
  // wrong password
  showPwError('Wrong password ‚Äî try again');
  // small shake for visual feedback
  pwModal.classList.remove('shake');
  // reflow then add class to retrigger animation
  void pwModal.offsetWidth;
  pwModal.classList.add('shake');
  // keep focus & select to make retry quick
  pwInput.focus();
  pwInput.select();
}

function showPwError(msg){
  pwError.textContent = msg;
  pwError.style.display = 'block';
}

/* MAIN APP UI init (runs only after unlock) */
function initUI(){
  // theme
  const savedTheme = localStorage.getItem('homely_theme') || 'light';
  setTheme(savedTheme);
  document.getElementById('theme-toggle').addEventListener('click', ()=> setTheme(state.theme === 'light' ? 'dark' : 'light'));

  // file upload / new / import / export
  fileInput.addEventListener('change', handleUpload);
  document.getElementById('new-btn').addEventListener('click', createNewReading);
  document.getElementById('export-btn').addEventListener('click', exportAll);
  document.getElementById('import-btn').addEventListener('click', ()=> importFile.click());
  importFile.addEventListener('change', handleImport);
  const authorInput = document.getElementById('author-input');
  authorInput.value = localStorage.getItem('homely_author') || '';
  authorInput.addEventListener('change', ()=> localStorage.setItem('homely_author', authorInput.value));

  // toolbar & annot modal buttons
  document.getElementById('annotate-btn').addEventListener('click', openAnnotModal);
  document.getElementById('highlight-btn').addEventListener('click', quickHighlight);
  document.getElementById('clear-selection').addEventListener('click', clearSelectionUI);
  document.getElementById('cancel-annot').addEventListener('click', ()=> { annotModal.style.display='none'; clearSelectionUI(); });
  document.getElementById('save-annot').addEventListener('click', saveAnnotationFromModal);

  // click highlight to show note
  readingEl.addEventListener('click', (e)=>{
    const span = e.target.closest('.highlight');
    if(!span) return;
    const aid = span.dataset.annId;
    const rid = state.currentReadingId;
    const ann = (state.annotations[rid] || []).find(a=>String(a.id)===String(aid));
    if(ann){
      alert(`"${ ann.note }"\n‚Äî ${ann.author||'Anonymous'} (${new Date(ann.created_at).toLocaleString()})`);
    }
  });

  // selection handler
  document.addEventListener('selectionchange', selectionChanged);

  renderReadingList();

  // auto-open most recent
  const ids = Object.keys(state.readings).sort((a,b)=> new Date(state.readings[b].created_at)-new Date(state.readings[a].created_at));
  if(ids.length) openReading(ids[0]);
  else {
    // add friendly sample if first run
    if(!localStorage.getItem('homely_sample_added')){
      const id = 'r_demo';
      state.readings[id] = { id, title: 'Demo reading', body: 'Welcome ‚Äî select some text to annotate.\n\nThis simple local annotator saves notes to your browser (localStorage). You can upload .txt/.md files using Upload. Use Export to back up.', created_at: (new Date()).toISOString(), filename: 'demo' };
      localStorage.setItem('homely_sample_added','1');
      saveAll();
      renderReadingList();
      openReading(id);
    }
  }
}

/* THEME */
function setTheme(t){ state.theme = t; document.getElementById('app').setAttribute('data-theme', t); localStorage.setItem('homely_theme', t); document.getElementById('theme-toggle').textContent = t==='light' ? 'üåô' : '‚òÄÔ∏è'; }

/* UPLOAD / NEW / IMPORT / EXPORT */
function handleUpload(e){
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = ()=> {
    const text = String(reader.result || '');
    const id = 'r_' + Date.now();
    const title = file.name.replace(/\.[^/.]+$/, "");
    state.readings[id] = { id, title, body: text, created_at: (new Date()).toISOString(), filename: file.name };
    saveAll();
    renderReadingList();
    openReading(id);
    fileInput.value = '';
  };
  reader.readAsText(file);
}
function createNewReading(){
  const title = prompt('Title for new reading') || `Untitled ${Object.keys(state.readings).length+1}`;
  const id = 'r_' + Date.now();
  state.readings[id] = { id, title, body: 'Paste your text here or click Edit ‚Üí Replace', created_at: (new Date()).toISOString(), filename: null };
  saveAll();
  renderReadingList();
  openReading(id);
}
function exportAll(){
  const payload = { readings: state.readings, annotations: state.annotations };
  const b = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(b);
  const a = document.createElement('a'); a.href = url; a.download = 'homely_backup.json'; a.click();
  URL.revokeObjectURL(url);
}
function handleImport(e){
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = ()=> {
    try{
      const data = JSON.parse(r.result);
      state.readings = data.readings || state.readings;
      state.annotations = data.annotations || state.annotations;
      saveAll();
      renderReadingList();
      alert('Imported.');
    }catch(err){ alert('Invalid JSON'); }
    importFile.value = '';
  };
  r.readAsText(f);
}

/* RENDER reading list */
function renderReadingList(){
  const keys = Object.keys(state.readings).sort((a,b)=> new Date(state.readings[b].created_at)-new Date(state.readings[a].created_at));
  readingList.innerHTML = keys.length ? keys.map(id=>{
    const r = state.readings[id];
    return `<div class="list-item" data-id="${id}"><div style="flex:1"><strong>${escapeHtml(r.title)}</strong><div class="muted small">${r.filename ? r.filename : ''} ‚Ä¢ ${new Date(r.created_at).toLocaleDateString()}</div></div><div><button class="btn-ghost" data-action="edit" data-id="${id}">Edit</button></div></div>`;
  }).join('') : `<div class="muted small">No readings yet</div>`;
  Array.from(readingList.querySelectorAll('.list-item')).forEach(el=>{
    el.addEventListener('click', (e)=>{
      const id = el.dataset.id;
      if(!id) return;
      if(e.target && e.target.dataset && e.target.dataset.action==='edit'){ editReading(id); e.stopPropagation(); return; }
      openReading(id);
    });
  });
  Array.from(readingList.querySelectorAll('button[data-action="edit"]')).forEach(b=>{
    b.addEventListener('click', (ev)=>{ const id = b.dataset.id; editReading(id); ev.stopPropagation(); });
  });
}

/* OPEN / RENDER a reading with annotations */
function openReading(id){
  if(!state.readings[id]) return;
  state.currentReadingId = id;
  titleArea.textContent = state.readings[id].title;
  metaArea.textContent = `${state.readings[id].filename || 'local text'} ¬∑ ${new Date(state.readings[id].created_at).toLocaleString()}`;
  readingEl.innerHTML = '';
  const holder = document.createElement('div');
  holder.id = '__raw_text_holder';
  holder.style.whiteSpace = 'pre-wrap';
  holder.style.outline = 'none';
  holder.textContent = state.readings[id].body || '';
  readingEl.appendChild(holder);
  renderAnnotationsInto(holder, id);
  renderAnnotationList();
}

/* Edit reading (replace body) */
function editReading(id){
  const r = state.readings[id];
  const newBody = prompt('Edit reading body (full text). Saving will replace the text and may shift annotation offsets.', r.body);
  if(newBody === null) return;
  r.body = newBody;
  saveAll();
  openReading(id);
}

/* render annotations into raw text holder (non-overlapping assumption) */
function renderAnnotationsInto(holder, readingId){
  const raw = holder.textContent || '';
  const anns = (state.annotations[readingId] || []).slice().sort((a,b)=> a.start - b.start);
  let out = '', cursor = 0;
  for(const a of anns){
    if(a.start > cursor) out += escapeHtml(raw.slice(cursor, a.start));
    const excerpt = escapeHtml(raw.slice(a.start, a.end));
    out += `<span class="highlight" data-ann-id="${a.id}" title="${escapeHtml(a.note || '')}">${excerpt}</span>`;
    cursor = a.end;
  }
  if(cursor < raw.length) out += escapeHtml(raw.slice(cursor));
  holder.innerHTML = out;
}

/* SELECTION -> toolbar & offsets (stable char offsets) */
let lastRange = null;
function selectionChanged(){
  const holder = document.getElementById('__raw_text_holder');
  if(!holder) return hideToolbar();
  const sel = window.getSelection();
  if(!sel || sel.rangeCount === 0) return hideToolbar();
  const range = sel.getRangeAt(0);
  if(!holder.contains(range.commonAncestorContainer)) return hideToolbar();
  const start = getCharacterOffsetWithin(holder, range.startContainer, range.startOffset);
  const end = getCharacterOffsetWithin(holder, range.endContainer, range.endOffset);
  if(start === -1 || end === -1 || start === end) return hideToolbar();
  const s = Math.min(start, end), e = Math.max(start, end);
  state.pendingSelection = { start: s, end: e, text: holder.textContent.slice(s,e) };
  lastRange = range.cloneRange();
  const rect = range.getBoundingClientRect();
  const t = toolbar;
  t.style.display = 'flex';
  const left = Math.max(8, rect.left + rect.width/2 - 80 + window.scrollX);
  const top = Math.max(8, rect.top - 40 + window.scrollY);
  t.style.left = left + 'px';
  t.style.top = top + 'px';
  selPreview.textContent = `"${state.pendingSelection.text.length>120 ? state.pendingSelection.text.slice(0,120)+'‚Ä¶' : state.pendingSelection.text}"`;
}
function hideToolbar(){ toolbar.style.display = 'none'; state.pendingSelection = null; lastRange = null; }

/* selection actions */
function clearSelectionUI(){ window.getSelection().removeAllRanges(); hideToolbar(); }
function openAnnotModal(){ if(!state.pendingSelection) return; annotModal.style.display = 'flex'; noteInput.value = ''; setTimeout(()=>noteInput.focus(), 50); }
function quickHighlight(){ if(!state.pendingSelection) return; const author = document.getElementById('author-input').value || localStorage.getItem('homely_author') || null; addAnnotation(state.currentReadingId, state.pendingSelection.start, state.pendingSelection.end, '', author); clearSelectionUI(); }
function saveAnnotationFromModal(){ const note = noteInput.value.trim(); const author = document.getElementById('author-input').value || localStorage.getItem('homely_author') || null; if(!state.pendingSelection) { alert('No selection.'); annotModal.style.display='none'; return; } addAnnotation(state.currentReadingId, state.pendingSelection.start, state.pendingSelection.end, note, author); annotModal.style.display = 'none'; clearSelectionUI(); }

/* add / delete annotation */
function addAnnotation(readingId, start, end, note, author){
  if(!readingId) return alert('No reading selected.');
  const id = 'a_' + Date.now() + '_' + Math.floor(Math.random()*1000);
  const ann = { id, start, end, note, author, created_at: (new Date()).toISOString() };
  if(!state.annotations[readingId]) state.annotations[readingId] = [];
  state.annotations[readingId].push(ann);
  saveAll();
  const holder = document.getElementById('__raw_text_holder');
  if(holder) renderAnnotationsInto(holder, readingId);
  renderAnnotationList();
}
function deleteAnnotation(aid){
  const id = state.currentReadingId;
  if(!id) return;
  state.annotations[id] = (state.annotations[id] || []).filter(a=> a.id !== aid);
  saveAll();
  openReading(id);
}

/* render annotation list and handlers */
function renderAnnotationList(){
  const id = state.currentReadingId;
  const anns = (state.annotations[id] || []).slice().sort((a,b)=> new Date(b.created_at) - new Date(a.created_at));
  if(!anns.length){ annotationsList.innerHTML = '<div class="muted">No annotations yet</div>'; return; }
  annotationsList.innerHTML = anns.map(a=>{
    const excerpt = (state.readings[id] && state.readings[id].body) ? state.readings[id].body.slice(a.start, a.end) : '';
    return `<div class="annotation-item" data-aid="${a.id}">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div><strong>${escapeHtml(a.author || 'Anonymous')}</strong><div class="meta">${new Date(a.created_at).toLocaleString()}</div></div>
        <div><button class="btn-ghost" data-action="del" data-id="${a.id}">Delete</button></div>
      </div>
      <div style="margin-top:6px">${escapeHtml(a.note || '(highlight)')}</div>
      <div class="muted" style="margin-top:6px"><em>Excerpt:</em> "${escapeHtml(excerpt)}"</div>
    </div>`;
  }).join('');
  Array.from(annotationsList.querySelectorAll('.annotation-item')).forEach(el=>{
    el.addEventListener('click', (e)=>{
      const aid = el.dataset.aid;
      jumpToAnnotation(aid);
    });
  });
  Array.from(annotationsList.querySelectorAll('button[data-action="del"]')).forEach(b=>{
    b.addEventListener('click', (ev)=>{
      ev.stopPropagation();
      const aid = b.dataset.id;
      if(confirm('Delete this annotation?')){ deleteAnnotation(aid); }
    });
  });
}

/* jump to annotation */
function jumpToAnnotation(aid){
  const id = state.currentReadingId;
  const anns = state.annotations[id] || [];
  const a = anns.find(x=>x.id===aid);
  if(!a) return;
  const holder = document.getElementById('__raw_text_holder');
  renderAnnotationsInto(holder, id);
  const el = holder.querySelector(`[data-ann-id="${aid}"]`);
  if(el){
    el.scrollIntoView({behavior:'smooth', block:'center'});
    const old = el.style.boxShadow;
    el.style.boxShadow = '0 0 0 3px rgba(246,192,125,0.6)';
    setTimeout(()=> el.style.boxShadow = old, 900);
  } else {
    alert('Annotation not found (text may have changed).');
  }
}

/* helper: compute char offsets in container */
function getCharacterOffsetWithin(containerEl, node, offset) {
  let chars = 0;
  const walker = document.createTreeWalker(containerEl, NodeFilter.SHOW_TEXT, null, false);
  let currentNode;
  while ((currentNode = walker.nextNode())) {
    if (currentNode === node) {
      return chars + offset;
    }
    chars += currentNode.textContent.length;
  }
  return -1;
}
function escapeHtml(s){ return (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }

/* click outside and keyboard shortcuts */
document.addEventListener('click', (e)=>{
  if(!toolbar.contains(e.target) && !annotModal.contains(e.target) && !e.target.closest('.highlight')) {
    setTimeout(()=> { if(!document.getSelection().toString()) clearSelectionUI(); }, 50);
  }
});
document.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape') { annotModal.style.display='none'; clearSelectionUI(); }
  if(e.ctrlKey && e.key === 'e'){ e.preventDefault(); exportAll(); }
});

/* utility: when there's no data show a small comment for first-time use */
console.log('Homely Annotator loaded. Edit PASSWORD at top of index.html to change the shared password.');

</script>
</body>
</html>
